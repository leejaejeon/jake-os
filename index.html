<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Jake WorkOS V48 - Engraving Master</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
    body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; color: #1e293b; -webkit-font-smoothing: antialiased; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f8fafc; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f8fafc; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .custom-scrollbar::-webkit-scrollbar { display: block; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; }
    .calendar-cell { min-height: 120px; background-color: #fff; padding: 4px; cursor: pointer; transition: background-color 0.2s; position: relative; }
    .calendar-cell:hover { background-color: #f8fafc; }
    .calendar-cell:active { background-color: #f1f5f9; }
    
    .modal-enter { animation: fadeIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

    .map-row { display: flex; flex-direction: row; justify-content: flex-start; gap: 4px; margin-bottom: 4px; width: max-content; }
    .map-slot { width: 85px; min-width: 85px; height: 70px; border-radius: 4px; border: 1px solid #cbd5e1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s; }
    .map-slot:active { opacity: 0.7; transform: scale(0.95); }
    .slot-spacer { visibility: hidden; pointer-events: none; border: none; background: transparent; } 
    .slot-id { font-size: 10px; font-weight: 800; margin-bottom: 2px; }
    .slot-name { font-size: 11px; font-weight: 800; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; letter-spacing: -0.5px; }

    .form-input { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; font-weight: bold; color: #1e293b; outline: none; transition: border-color 0.2s; background-color: #f8fafc; }
    .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: #ffffff; }
    .form-label { display: block; font-size: 11px; font-weight: 900; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    Chart.register(ChartDataLabels);

    const SUPABASE_URL = 'https://lqccxnciiajwqdmpwjdv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxY2N4bmNpaWFqd3FkbXB3amR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjA3MTMsImV4cCI6MjA4NzA5NjcxM30.L23-eq-DIPsbONOeX-xQ8UcMb7gtgTTTRpkaSm9HTw4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const clean = (val) => (!val || val === '0.0' || val === '0' || val === 'null' || val === ' -  - ' || val === 'SPACER') ? '' : String(val).trim();
    const normalizeDate = (v) => { 
      if(!v) return null; 
      try {
        const s = String(v).replace(/\./g,'-').replace(/\s/g,'').substring(0,10);
        const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
        return m ? `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}` : null;
      } catch(e) { return null; }
    };
    
    // ë¹ˆ ê°’ì„ DBê°€ ì¸ì‹í•  ìˆ˜ ìˆëŠ” ìˆœìˆ˜ nullë¡œ ì¹˜í™˜í•´ì£¼ëŠ” í•¨ìˆ˜ (ì—ëŸ¬ ë°©ì§€ í•µì‹¬)
    const nullIfEmpty = (val) => {
        const c = String(val).trim();
        return c === '' ? null : c;
    };

    const getNowStr = () => {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
    };
    const getTodayStr = () => new Date().toISOString().split('T')[0];
    const formatMoney = (val) => { try { const num = parseInt(String(val).replace(/[^0-9]/g, '')); return isNaN(num) ? '0ì›' : num.toLocaleString() + 'ì›'; } catch(e) { return '0ì›'; } };

    const renderWithLinks = (text) => {
        if(!text) return null;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const parts = String(text).split(urlRegex);
        return parts.map((part, i) => {
            if(part.match(urlRegex)) return <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline break-all" onClick={e=>e.stopPropagation()}>{part}</a>;
            return part;
        });
    };

    const SECTION_LIST = ['A2/ê°€','A3/ê°€','A4/ê°€','A4/ë‚˜','A4/ë‹¤','A5/ê°€','A5/ë‚˜','A6/ê°€','A6/ë‚˜','B1/ê°€','B2/ê°€','B3/ê°€','B4/ê°€','B5/ê°€','B6/ê°€/1-12','B6/ê°€/13-14','C1/ê°€'];
    const ROW_CONFIG = { 'A2/ê°€':[12], 'A3/ê°€':[8,8], 'A4/ê°€':[12,12,12,12,18,18,28,12], 'A4/ë‚˜':[9,11,7,8,8], 'A4/ë‹¤':[6,6], 'A5/ê°€':[13,14,14,13,13,15,11], 'A5/ë‚˜':[23,22,26,25,30,47,47,30,39], 'A6/ê°€':[27,27,22,18,19,15,13], 'A6/ë‚˜':[25,26,26,26,26,26], 'C1/ê°€':[13,17,21,25], 'B1/ê°€':[20,23], 'B2/ê°€':[34,34,35,34,34], 'B3/ê°€':[48,46,45,41], 'B4/ê°€':[37,38,41,41,34], 'B5/ê°€':[47,47,49,48,40,32], 'B6/ê°€/1-12':[47,52,53,52,53,53,54,54,54,53,55,54,50], 'B6/ê°€/13-14':[75,75,75,75,75,75,75,75,75] };

    const EMPLOYEES = ["ì¡°ê·œíƒœ ì‚¬ë¬´ì¥", "ì´ì¤‘ì› íŒ€ì¥", "ì´ì¥ìˆœ ê³¼ì¥", "í—ˆì„±ë°± ê³¼ì¥", "ì „ê´‘ìˆ™ ì‹¤ì¥", "ì´ì¬ì „ ê³¼ì¥", "ë°•ìš°ì„ ì°¨ì¥"];
    const EMP_COLORS = ["#FF6B6B", "#FF9F43", "#FDCB6E", "#55E6C1", "#4BCFFA", "#5F27CD", "#D980FA"];
    const EMP_WEIGHTS = { "ì¡°ê·œíƒœ ì‚¬ë¬´ì¥": { contract: 1, guide: 1, burial: 1, landscaping: 1 }, "ì´ì¤‘ì› íŒ€ì¥": { contract: 0, guide: 0, burial: 1, landscaping: 1 }, "ì´ì¥ìˆœ ê³¼ì¥": { contract: 0.5, guide: 1, burial: 1, landscaping: 1 }, "í—ˆì„±ë°± ê³¼ì¥": { contract: 0, guide: 0, burial: 1, landscaping: 1 }, "ì „ê´‘ìˆ™ ì‹¤ì¥": { contract: 1, guide: 1, burial: 0, landscaping: 0 }, "ì´ì¬ì „ ê³¼ì¥": { contract: 0.5, guide: 0.5, burial: 0, landscaping: 1 }, "ë°•ìš°ì„ ì°¨ì¥": { contract: 1, guide: 1, burial: 0, landscaping: 1 } };

    const logAction = async (category, actionType, targetData, details) => { try { await supabaseClient.from('system_logs').insert({ worker: 'JAKE (Admin)', action_type: actionType, target_data: targetData, details: details }); } catch(e) {} };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      render() {
        if (this.state.hasError) return ( <div className="p-8 m-4 bg-rose-50 border-2 border-rose-500 rounded-xl shadow-lg"><h1 className="text-xl font-black text-rose-700 mb-2">ğŸš¨ V48 ë Œë”ë§ ì—ëŸ¬</h1><pre className="text-xs bg-white p-4 rounded border border-rose-200 overflow-auto">{this.state.error?.toString()}</pre></div> );
        return this.props.children; 
      }
    }

    function Modal({ isOpen, onClose, title, children, isNested = false, fullScreen = false }) {
      if (!isOpen) return null;
      const zIndex = isNested ? "z-[110]" : "z-[100]"; 
      const screenStyle = fullScreen ? "w-full h-full rounded-none" : "w-full max-w-md max-h-[85vh] rounded-2xl shadow-2xl";
      const bgOpacity = fullScreen ? "bg-slate-900" : (isNested ? "bg-slate-900/50" : "bg-slate-900/70");

      return (
        <div className={`fixed inset-0 flex items-center justify-center ${fullScreen ? 'p-0' : 'p-4'} ${bgOpacity} ${zIndex}`} onClick={fullScreen ? undefined : onClose}>
          <div className={`bg-white overflow-hidden flex flex-col modal-enter ${screenStyle}`} onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
              <h3 className="text-lg font-black text-slate-800 tracking-tight">{title}</h3>
              <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-lg text-slate-500 font-bold transition flex items-center gap-1">
                  {fullScreen ? <><span className="text-xl">â†</span> ë‹«ê¸°</> : 'âœ•'}
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 bg-slate-50/50 relative">{children}</div>
          </div>
        </div>
      );
    }

    function MapSelectorModal({ isOpen, onClose, layoutData, onSelectLocation }) {
      const [area, setArea] = useState('A6/ê°€');
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        if(!isOpen) return;
        const fetchField = async () => {
          setLoading(true);
          try { const res = await supabaseClient.from('field_data').select('ìœ„ì¹˜_ë²ˆí˜¸, ê³„ì•½_ìƒíƒœ, ì„±í•¨').eq('êµ¬ì—­', area); setData(res.data || []); } catch(e) {}
          setLoading(false);
        };
        fetchField();
      }, [area, isOpen]);

      const renderedGrid = useMemo(() => {
        if (!layoutData || !layoutData[area]) return [];
        const dataMap = {}; data.forEach(item => { if (item.ìœ„ì¹˜_ë²ˆí˜¸) dataMap[item.ìœ„ì¹˜_ë²ˆí˜¸] = item; });
        const comp = layoutData[area]; let finalRows = [];
        if (Array.isArray(comp[0])) finalRows = comp;
        else {
            const flat = [];
            comp.forEach(item => {
                if (typeof item === 'string' && item.startsWith('_')) { const count = parseInt(item.substring(1)) || 1; for(let i=0; i<count; i++) flat.push('SPACER'); } 
                else flat.push(item);
            });
            const config = ROW_CONFIG[area] || [20]; let idx = 0;
            config.forEach(cnt => { if(idx < flat.length) { finalRows.push(flat.slice(idx, idx + cnt)); idx += cnt; } });
        }
        return finalRows.map((rowSlots, rIdx) => ({
            rowNum: rIdx + 1,
            slots: rowSlots.map((slotId, sIdx) => {
                if (!slotId || slotId === 'SPACER' || (typeof slotId === 'string' && slotId.startsWith('_'))) return { type: 'spacer', id: `spacer-${rIdx}-${sIdx}` };
                return { type: 'data', ...(dataMap[slotId] || { ìœ„ì¹˜_ë²ˆí˜¸: slotId, ê³„ì•½_ìƒíƒœ: 'ë¯¸ë¶„ì–‘' }) };
            })
        }));
      }, [data, area, layoutData]);

      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 flex items-center justify-center p-2 sm:p-4 bg-slate-900/80 z-[120]" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col modal-enter" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-800 shrink-0">
              <h3 className="text-lg font-black text-white tracking-tight">ğŸ“ ì§€ë„ì—ì„œ ìœ„ì¹˜ ì„ íƒ</h3>
              <button onClick={onClose} className="p-1 bg-slate-700 hover:bg-slate-600 rounded-lg text-white font-bold transition">ë‹«ê¸°</button>
            </div>
            <div className="flex gap-2 overflow-x-auto p-3 border-b border-slate-200 bg-slate-100 custom-scrollbar shrink-0" style={{ WebkitOverflowScrolling: 'touch' }}>
              {SECTION_LIST.map(s => (
                <button key={s} onClick={() => setArea(s)} className={`flex-none px-4 py-2 rounded-lg font-bold text-[13px] whitespace-nowrap transition-all border border-slate-300 ${area === s ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>{s}</button>
              ))}
            </div>
            <div className="flex-1 overflow-auto bg-[#F8FAFC] p-4 relative">
              {loading ? ( <div className="flex h-full items-center justify-center font-black text-slate-400">ë°ì´í„° ë¡œë”©ì¤‘...</div> ) : (
                <div className="min-w-max pb-10 pr-10 mx-auto">
                  {renderedGrid.map((row, rIdx) => (
                    <div key={rIdx} className="map-row">
                      {row.slots.map((s) => {
                        if (s.type === 'spacer') return <div key={s.id} className="map-slot slot-spacer"></div>;
                        const st = clean(s.ê³„ì•½_ìƒíƒœ) || 'ë¯¸ë¶„ì–‘';
                        const cols = { 'ì•ˆì¹˜':'bg-emerald-700 text-white opacity-40', 'ì˜ˆì•½':'bg-amber-300 text-amber-900', 'í™€ë”©':'bg-rose-600 text-white', 'ë¯¸ë¶„ì–‘':'bg-white text-slate-600 hover:bg-blue-50 border-blue-300 shadow-md hover:-translate-y-1' };
                        return (
                          <div key={s.id || s.ìœ„ì¹˜_ë²ˆí˜¸} onClick={() => onSelectLocation(`${area}/${s.ìœ„ì¹˜_ë²ˆí˜¸}`)} className={`map-slot ${cols[st] || cols['ë¯¸ë¶„ì–‘']}`}>
                            <div className="slot-id">{s.ìœ„ì¹˜_ë²ˆí˜¸}</div>
                            <div className="slot-name">{st === 'ë¯¸ë¶„ì–‘' ? 'ì„ íƒê°€ëŠ¥' : (clean(s.ì„±í•¨) || st)}</div>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    function DashboardView({ layoutData }) {
      const [loading, setLoading] = useState(true);
      const [events, setEvents] = useState([]);
      const [hrData, setHrData] = useState([]);
      const [currentDate, setCurrentDate] = useState(new Date());
      
      const [dailyModal, setDailyModal] = useState({ isOpen: false, dateStr: '', events: [] });
      const [undecidedModalOpen, setUndecidedModalOpen] = useState(false);
      const [salesModal, setSalesModal] = useState({ isOpen: false, data: null });
      const [schModal, setSchModal] = useState({ isOpen: false, data: null });
      
      const [mapSelectorOpen, setMapSelectorOpen] = useState(false);
      const [selectedLocBase, setSelectedLocBase] = useState('');
      const [gwangjung, setGwangjung] = useState('');
      
      const [globalSearch, setGlobalSearch] = useState('');
      const [salesSearch, setSalesSearch] = useState('');

      const fetchAll = async () => {
        setLoading(true);
        try {
          const [burRes, salRes, hrRes] = await Promise.all([
            supabaseClient.from('burial_schedule').select('*'),
            supabaseClient.from('status_mgmt').select('*'),
            supabaseClient.from('hr_management').select('*')
          ]);
          const bEvs = (burRes.data || []).map(b => ({ id: b.id, type:'burial', date:normalizeDate(b.ì•ˆì¹˜ì¼), title:clean(b.ê³ ì¸ëª…), sub:clean(b.ìœ„ì¹˜), raw:b }));
          const sEvs = (salRes.data || []).map(s => {
            const custName = clean(s['ê³ ê°_ê³ ì¸_ëª…'] || s['ê³ ê°(ê³ ì¸)ëª…'] || s.ê³ ê°ëª… || 'ì´ë¦„ì—†ìŒ');
            return { id: s.id, type:'sales', date:normalizeDate(s.ë‹µì‚¬ì¼)||normalizeDate(s.ë“±ë¡ì¼), title:custName, sub:`${clean(s.ì˜ì—…ìì‚¬ëª…)}/${clean(s.ì˜ì—…ìì„±í•¨)}`, status:s.í˜„ì¬ìƒíƒœ, raw:s, regDate: new Date(s.ë“±ë¡ì¼ || 0) };
          });
          setEvents([...bEvs, ...sEvs].filter(e => e.date !== null));
          
          let cleanHr = (hrRes.data || []).map(r => {
             let d = r.work_date; let n = r.worker_name;
             if (d && n && (d.includes('ê³¼ì¥') || d.includes('íŒ€ì¥') || d.includes('ì‹¤ì¥') || d.includes('ì‚¬ë¬´ì¥') || d.includes('ì°¨ì¥'))) { let temp = d; d = n; n = temp; }
             if (d) {
                 d = d.replace(/ë…„\s*/g, '-').replace(/ì›”\s*/g, '-').replace(/ì¼\s*/g, '').replace(/\s+/g, '');
                 const parts = d.split('-'); if(parts.length === 3) d = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
             }
             return { ...r, work_date: d, worker_name: n };
          });
          setHrData(cleanHr);
        } catch (e) {} finally { setLoading(false); }
      };

      useEffect(() => { fetchAll(); }, []);

      const calendarDays = useMemo(() => {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const startDay = new Date(year, month, 1).getDay(), offset = startDay === 0 ? 6 : startDay - 1;
        const lastDate = new Date(year, month + 1, 0).getDate();
        const days = [];
        for (let i = 0; i < offset; i++) days.push(null);
        for (let i = 1; i <= lastDate; i++) {
          const ds = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          days.push({ day: i, dateStr: ds, dayEvents: events.filter(e => e.date === ds && e.status !== 'ìƒë‹´ í›„ ëŒ€ê¸°') });
        }
        return days;
      }, [currentDate, events]);

      const getCleanedHR = (data) => {
        let map = {}; data.forEach(r => { if(r.work_date && r.worker_name) map[`${r.work_date}_${r.worker_name}`] = r.status; }); return map;
      };

      const headlineStats = useMemo(() => {
        const targetDate = dailyModal.isOpen ? dailyModal.dateStr : getTodayStr();
        const todaysEvents = events.filter(e => e.date === targetDate);
        const burials = todaysEvents.filter(e => e.type === 'burial').length;
        const sales = todaysEvents.filter(e => e.type === 'sales' && (e.status === 'ë‹µì‚¬ëŒ€ê¸°' || e.status === 'ë‹µì‚¬ì™„ë£Œ')).length;
        
        let hrCount = 0;
        const cln = getCleanedHR(hrData);
        EMPLOYEES.forEach(emp => {
            const st = cln[`${targetDate}_${emp}`];
            if(st) {
                if(['íœ´ë¬´','ì—°ì°¨','ë³‘ê°€'].includes(st)) hrCount += 1;
                else if(['ë°˜ì°¨','ì˜¤ì „ë°˜ì°¨','ì˜¤í›„ë°˜ì°¨','ì¡°í‡´'].includes(st)) hrCount += 0.5;
            }
        });
        return { targetDate, burials, sales, hr: hrCount };
      }, [events, hrData, dailyModal.isOpen, dailyModal.dateStr]);

      const undecidedList = useMemo(() => {
        let list = events.filter(e => e.type === 'sales' && e.status !== 'ì•ˆì¹˜í™•ì •' && e.status !== 'ì·¨ì†Œ');
        return list.sort((a, b) => b.regDate.getTime() - a.regDate.getTime());
      }, [events]);

      const filteredUndecided = useMemo(() => {
          if(!salesSearch.trim()) return undecidedList;
          const q = salesSearch.toLowerCase(); const qPhone = q.replace(/[^0-9]/g, '');
          return undecidedList.filter(ev => {
              const raw = ev.raw; const corp = String(raw.ì˜ì—…ìì‚¬ëª…||'').toLowerCase(); const staff = String(raw.ì˜ì—…ìì„±í•¨||'').toLowerCase(); const cust = String(ev.title || raw.ê³ ê°_ê³ ì¸_ëª… || '').toLowerCase(); const memo = String(raw.ë¹„ê³ ë©”ëª¨ || raw.ë¹„ê³  || raw.ë©”ëª¨ || '').toLowerCase(); 
              const phoneMatches = qPhone ? String(raw.ì—°ë½ì²˜||'').replace(/[^0-9]/g, '').includes(qPhone) : false;
              return corp.includes(q) || staff.includes(q) || cust.includes(q) || memo.includes(q) || phoneMatches;
          });
      }, [undecidedList, salesSearch]);

      const globalSearchResults = useMemo(() => {
          if(!globalSearch.trim()) return [];
          const q = globalSearch.toLowerCase(); const qPhone = q.replace(/[^0-9]/g, '');
          return events.filter(ev => {
              const raw = ev.raw || {}; const title = String(ev.title||'').toLowerCase(); const sub = String(ev.sub||'').toLowerCase(); const memo = String(raw.ë¹„ê³ ë©”ëª¨ || raw.ë¹„ê³  || '').toLowerCase(); const status = String(ev.status||'').toLowerCase();
              const phoneMatches = qPhone ? String(raw.ì—°ë½ì²˜||'').replace(/[^0-9]/g, '').includes(qPhone) : false;
              return title.includes(q) || sub.includes(q) || memo.includes(q) || status.includes(q) || phoneMatches;
          }).sort((a,b) => new Date(b.date||0) - new Date(a.date||0));
      }, [events, globalSearch]);

      const handleCellClick = (dateStr, dayEvents) => {
          setGlobalSearch(''); 
          setDailyModal({ isOpen: true, dateStr, events: dayEvents || events.filter(e => e.date === dateStr && e.status !== 'ìƒë‹´ í›„ ëŒ€ê¸°') }); 
      };

      const saveSchedule = async (e) => {
          e.preventDefault();
          const targetLoc = gwangjung ? `${selectedLocBase}[${gwangjung}]` : selectedLocBase;
          const payload = {
              ì•ˆì¹˜ì¼: nullIfEmpty(e.target.sch_date.value), ê³„ì•½ë²ˆí˜¸: nullIfEmpty(e.target.sch_no.value), ê³ ì¸ëª…: nullIfEmpty(e.target.sch_name.value),
              ê³„ì•½ì: nullIfEmpty(e.target.sch_contractor.value), ìœ„ì¹˜: nullIfEmpty(targetLoc), ë¹„ê³ : nullIfEmpty(e.target.sch_note.value)
          };
          let err;
          if(schModal.data?.id) { const res = await supabaseClient.from('burial_schedule').update(payload).eq('id', schModal.data.id); err = res.error; } 
          else { const res = await supabaseClient.from('burial_schedule').insert(payload); err = res.error; }
          if(err) { alert(`ì €ì¥ ì‹¤íŒ¨: ${err.message}`); return; }
          logAction('ì•ˆì¹˜ì¼ì •', schModal.data ? 'ìˆ˜ì •' : 'ì‹ ê·œë“±ë¡', payload.ê³ ì¸ëª…, `ë‚ ì§œ: ${payload.ì•ˆì¹˜ì¼}`);
          setSchModal({isOpen:false, data:null}); fetchAll(); 
      };

      const deleteSchedule = async (id) => {
          if(confirm('ì´ ì•ˆì¹˜ ì¼ì •ì„ ì •ë§ ì‚­ì œ(ë³´ê´€)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              const res = await supabaseClient.from('burial_schedule').delete().eq('id', id);
              if(res.error) { alert("ì‚­ì œ ì‹¤íŒ¨: " + res.error.message); return; }
              logAction('ì•ˆì¹˜ì¼ì •', 'ì‚­ì œ', id, 'ì‚­ì œë¨');
              setSchModal({isOpen:false, data:null}); fetchAll();
          }
      };

      const saveSales = async (e) => {
          e.preventDefault();
          const payload = {
              ë“±ë¡ì¼: e.target.s_regDate.value || getNowStr(), ë‹µì‚¬ì¼: nullIfEmpty(e.target.s_visitDate.value),
              ì˜ì—…ìì‚¬ëª…: nullIfEmpty(e.target.s_corp.value), ì˜ì—…ìì„±í•¨: nullIfEmpty(e.target.s_staff.value),
              ê³ ê°_ê³ ì¸_ëª…: nullIfEmpty(e.target.s_customer.value), ì—°ë½ì²˜: nullIfEmpty(e.target.s_phone.value),
              ê³„ì•½êµ¬ë¶„: nullIfEmpty(e.target.s_type.value), í˜„ì¬ìƒíƒœ: nullIfEmpty(e.target.s_status.value),
              ì•ˆì¹˜í™•ì •ì¼: nullIfEmpty(e.target.s_confirmDate.value), ë¹„ê³ ë©”ëª¨: nullIfEmpty(e.target.s_memo.value)
          };
          let err;
          if(salesModal.data?.id) { const res = await supabaseClient.from('status_mgmt').update(payload).eq('id', salesModal.data.id); err = res.error; } 
          else { const res = await supabaseClient.from('status_mgmt').insert(payload); err = res.error; }
          if(err) { alert(`ğŸš¨ DB ê±°ë¶€ë¨: ${err.message}`); return; }
          logAction('ì˜ì—…í˜„í™©', salesModal.data ? 'ìˆ˜ì •' : 'ì‹ ê·œë“±ë¡', payload.ê³ ê°_ê³ ì¸_ëª…, `ìƒíƒœ: ${payload.í˜„ì¬ìƒíƒœ}`);
          setSalesModal({isOpen:false, data:null}); fetchAll();
      };

      const deleteSales = async (id) => {
          if(confirm('ì´ ì˜ì—… ì¼ì •ì„ ì •ë§ ì‚­ì œ(ë³´ê´€)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
              const res = await supabaseClient.from('status_mgmt').delete().eq('id', id);
              if(res.error) { alert("ì‚­ì œ ì‹¤íŒ¨: " + res.error.message); return; }
              logAction('ì˜ì—…í˜„í™©', 'ì‚­ì œ', id, 'ì‚­ì œë¨');
              setSalesModal({isOpen:false, data:null}); fetchAll();
          }
      };

      return (
        <div className="space-y-6 max-w-7xl mx-auto flex flex-col relative w-full">
          
          <div onClick={() => handleCellClick(getTodayStr())} className="bg-slate-800 rounded-2xl p-4 shadow-lg text-white flex justify-between items-center cursor-pointer hover:bg-slate-700 transition">
            <div>
              <p className="text-xs font-bold text-slate-400 mb-1">{headlineStats.targetDate === getTodayStr() ? 'TODAY SUMMARY' : `SUMMARY: ${headlineStats.targetDate}`}</p>
              <div className="flex gap-4">
                <div className="flex items-end gap-1"><span className="text-2xl font-black text-emerald-400">{headlineStats.burials}</span><span className="text-sm font-bold text-slate-300 pb-1">ì•ˆì¹˜</span></div>
                <div className="flex items-end gap-1"><span className="text-2xl font-black text-amber-400">{headlineStats.sales}</span><span className="text-sm font-bold text-slate-300 pb-1">ë‹µì‚¬</span></div>
                <div className="flex items-end gap-1"><span className="text-2xl font-black text-blue-400">{headlineStats.hr}</span><span className="text-sm font-bold text-slate-300 pb-1">íœ´ë¬´</span></div>
              </div>
            </div>
            <div className="hidden sm:block text-right">
              <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Jake WorkOS</p>
              <p className="text-sm font-black text-emerald-400">DATABASE ACTIVE</p>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow border border-slate-200 flex flex-col overflow-hidden">
            
            <div className="p-3 border-b border-slate-100 bg-slate-50 relative z-[95]">
                <input type="text" placeholder="ğŸ” ëª¨ë“  ì¼ì • ë”¥ ì„œì¹˜ (ì•ˆì¹˜ì, ê³ ê°ëª…, ì—°ë½ì²˜, ë¹„ê³ ...)" value={globalSearch} onChange={e=>setGlobalSearch(e.target.value)} className="w-full p-2.5 rounded-xl border border-slate-300 shadow-inner text-sm font-bold focus:border-blue-500 focus:outline-none bg-white" />
                {globalSearchResults.length > 0 && (
                     <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-2xl rounded-xl mt-1 max-h-80 overflow-y-auto custom-scrollbar">
                         {globalSearchResults.map(ev => (
                             <div key={ev.id} onClick={() => { handleCellClick(ev.date); }} className="p-3 border-b hover:bg-blue-50 cursor-pointer transition">
                                 <div className="flex justify-between items-center mb-1">
                                     <span className="font-black text-slate-800">{ev.title} <span className="text-slate-500 text-xs font-bold ml-1">({ev.sub})</span></span>
                                     <span className={`text-[10px] px-2 py-0.5 rounded font-black ${ev.type==='burial'?'bg-emerald-100 text-emerald-700':'bg-amber-100 text-amber-700'}`}>{ev.type==='burial'?'ì•ˆì¹˜':'ì˜ì—…'} {ev.status}</span>
                                 </div>
                                 <div className="text-xs font-bold text-blue-600 mb-0.5">ì¼ì •: {ev.date || 'ë¯¸ì •'}</div>
                                 <div className="text-xs text-slate-500 truncate">{clean(ev.raw?.ë¹„ê³ ë©”ëª¨ || ev.raw?.ë¹„ê³ )}</div>
                             </div>
                         ))}
                     </div>
                 )}
            </div>

            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white">
              <div className="flex items-center space-x-4">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="px-3 py-1 bg-white border border-slate-200 hover:bg-slate-100 transition rounded-lg font-bold">â—€</button>
                <h2 className="text-xl font-black text-slate-800">{currentDate.getFullYear()}ë…„ {currentDate.getMonth()+1}ì›”</h2>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="px-3 py-1 bg-white border border-slate-200 hover:bg-slate-100 transition rounded-lg font-bold">â–¶</button>
              </div>
            </div>
            <div className="px-4 pt-4">
              <button onClick={() => { setSalesSearch(''); setUndecidedModalOpen(true); }} className="w-full bg-orange-50 hover:bg-orange-100 transition text-orange-700 border border-orange-200 font-black py-3 rounded-xl shadow-sm flex justify-between px-4">
                  <span>ğŸ“ ì˜ì—… ëŒ€ê¸° ë° ì„ ì  ëª…ë‹¨ í™•ì¸</span>
                  <span className="bg-orange-500 text-white px-2 py-0.5 rounded-lg">{undecidedList.length}ê±´</span>
              </button>
            </div>
            <div className="bg-white p-2 md:p-4 pb-6">
              <div className="w-full flex flex-col border border-slate-200 rounded-xl shadow-sm bg-slate-200 gap-px">
                <div className="grid grid-cols-7 gap-px">{['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].map((d,i)=>(<div key={d} className={`py-2 text-center text-sm font-black bg-white ${i===6?'text-red-500':i===5?'text-blue-500':'text-slate-700'}`}>{d}</div>))}</div>
                <div className="grid grid-cols-7 gap-px">
                  {calendarDays.map((d,i)=>(
                    <div key={i} onClick={()=>d && handleCellClick(d.dateStr, d.dayEvents)} className={`calendar-cell flex flex-col ${!d?'bg-slate-50 cursor-default':'cursor-pointer'}`}>
                      {d && (
                        <>
                          <div className={`pointer-events-none text-right text-xs font-bold p-1 ${getTodayStr() === d.dateStr ? 'text-white bg-blue-600 inline-block self-end rounded-md px-2' : 'text-slate-500'}`}>{d.day}</div>
                          <div className="pointer-events-none space-y-1 pb-1">
                            {d.dayEvents.map((ev,idx)=>{
                              const isCancel = ev.status === 'ì·¨ì†Œ'; const isDone = ev.status === 'ë‹µì‚¬ì™„ë£Œ' || ev.status === 'ì•ˆì¹˜í™•ì •';
                              let st = ev.type === 'burial' ? 'bg-emerald-600 text-white' : (isCancel ? 'bg-slate-200 text-slate-500 line-through' : isDone ? 'bg-blue-100 text-blue-800' : 'bg-amber-300 text-amber-900');
                              return <div key={idx} className={`px-1.5 py-0.5 rounded text-[10px] font-bold truncate shadow-sm ${st}`}>{ev.title}</div>
                            })}
                          </div>
                        </>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
          
          <Modal isOpen={dailyModal.isOpen} onClose={()=>setDailyModal({...dailyModal, isOpen:false})} title={`ğŸ“… ${dailyModal.dateStr} ì¼ì •`}>
            {dailyModal.events.length === 0 ? <div className="text-center p-8 text-slate-400 font-bold">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div> : (
              <div className="space-y-2">
                {dailyModal.events.map((ev, idx) => {
                  const isCancel = ev.status === 'ì·¨ì†Œ'; const isDone = ev.status === 'ë‹µì‚¬ì™„ë£Œ' || ev.status === 'ì•ˆì¹˜í™•ì •';
                  if (ev.type === 'sales') {
                    const bg = isCancel ? "bg-slate-100 text-slate-500" : (isDone ? "bg-blue-50 border-blue-200" : "bg-yellow-50 border-amber-300 hover:bg-yellow-100");
                    return (
                      <div key={idx} onClick={() => setSalesModal({isOpen:true, data:ev})} className={`p-3 rounded-xl border cursor-pointer transition shadow-sm ${bg}`}>
                        <div className="font-black text-[13px] mb-1" style={{textDecoration: isCancel ? "line-through" : "none"}}>ğŸŸ¡ [ì˜ì—…] {ev.sub} - {ev.title} <span className="float-right text-[11px] bg-white/50 px-1.5 rounded">{ev.status}</span></div>
                        <div className="text-[11px] font-bold opacity-70 whitespace-pre-wrap">{clean(ev.raw.ë¹„ê³ ë©”ëª¨) || 'ë©”ëª¨ ì—†ìŒ'}</div>
                      </div>
                    );
                  } else {
                    return (
                      <div key={idx} onClick={() => { 
                          setSchModal({isOpen:true, data:ev}); 
                          const locMatch = clean(ev.raw.ìœ„ì¹˜).match(/^(.*?)\[(\d+)\]$/);
                          if(locMatch) { setSelectedLocBase(locMatch[1]); setGwangjung(locMatch[2]); }
                          else { setSelectedLocBase(clean(ev.raw.ìœ„ì¹˜)); setGwangjung(''); }
                        }} className="p-3 rounded-xl border border-emerald-700 bg-emerald-600 text-white cursor-pointer hover:bg-emerald-700 transition shadow-sm">
                        <div className="font-black text-[13px] mb-1">ğŸŸ¢ [ì•ˆì¹˜] {ev.title} <span className="float-right text-[11px] bg-black/20 px-1.5 rounded">{ev.sub}</span></div>
                        <div className="text-[11px] font-medium opacity-90 whitespace-pre-wrap">{clean(ev.raw.ë¹„ê³ ) || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}</div>
                      </div>
                    );
                  }
                })}
              </div>
            )}
            <div className="mt-4 flex gap-2">
                <button onClick={() => setSalesModal({isOpen:true, data:null})} className="flex-1 py-3 bg-amber-50 text-amber-700 border border-amber-200 font-bold rounded-xl text-sm shadow-sm hover:bg-amber-100 transition">+ ì˜ì—… ë“±ë¡</button>
                <button onClick={() => { setSelectedLocBase(''); setGwangjung(''); setSchModal({isOpen:true, data:null}); }} className="flex-1 py-3 bg-emerald-50 text-emerald-700 border border-emerald-200 font-bold rounded-xl text-sm shadow-sm hover:bg-emerald-100 transition">+ ì•ˆì¹˜ ë“±ë¡</button>
            </div>
          </Modal>

          <Modal isOpen={undecidedModalOpen} onClose={()=>setUndecidedModalOpen(false)} title="ğŸ“ ì˜ì—… ëŒ€ê¸° ë° ì„ ì  ëª…ë‹¨">
              <div className="mb-4">
                  <input type="text" value={salesSearch} onChange={e=>setSalesSearch(e.target.value)} placeholder="ğŸ” ê³ ê°ëª…, ì‚¬ëª…, ì—°ë½ì²˜, ë¹„ê³  ê²€ìƒ‰..." className="w-full p-3 rounded-xl border border-slate-300 text-sm font-bold bg-white focus:border-blue-500 focus:outline-none" />
              </div>
              <div className="space-y-2 max-h-[55vh] overflow-y-auto no-scrollbar">
                  {filteredUndecided.map(ev => (
                      <div key={ev.id} onClick={() => setSalesModal({isOpen:true, data:ev})} className="p-3 bg-white border border-orange-200 rounded-xl cursor-pointer hover:bg-orange-50 shadow-sm transition">
                          <div className="flex justify-between items-center mb-1.5">
                              <span className="font-black text-[14px] text-slate-800">{ev.title} <span className="text-slate-500 font-bold text-[12px]">({ev.sub})</span></span>
                              <span className="text-[10px] font-black text-orange-600 bg-orange-100 px-2 py-0.5 rounded">{ev.status}</span>
                          </div>
                          <div className="text-[12px] font-bold text-blue-600 mb-1">ğŸ“ {ev.raw?.ì—°ë½ì²˜ || 'ì—°ë½ì²˜ ì—†ìŒ'}</div>
                          <div className="text-[11px] text-slate-500 font-bold">â° ë“±ë¡: {normalizeDate(ev.raw?.ë“±ë¡ì¼) || ev.raw?.ë“±ë¡ì¼ || '-'}</div>
                      </div>
                  ))}
                  {filteredUndecided.length === 0 && <div className="text-center p-5 text-slate-400 font-bold">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
              </div>
          </Modal>

          <Modal isOpen={salesModal.isOpen} onClose={()=>setSalesModal({isOpen:false, data:null})} title={salesModal.data ? "ğŸŸ¡ ì˜ì—… í˜„í™© ìˆ˜ì •" : "ğŸ“ ì˜ì—… í˜„í™© ì‹ ê·œ ë“±ë¡"} isNested={true}>
              <form onSubmit={saveSales} className="space-y-4">
                  <div className="input-group">
                      <label className="form-label">ë“±ë¡ ì¼ì‹œ (ì‹œê°„ í¬í•¨)</label>
                      <input name="s_regDate" type="text" className="form-input bg-yellow-50 text-red-600" defaultValue={salesModal.data?.raw?.ë“±ë¡ì¼ || ''} placeholder="ë¹ˆì¹¸ ì‹œ í˜„ì¬ ì‹œê°„ ìë™ ê¸°ë¡" />
                  </div>
                  <div className="input-group">
                      <label className="form-label">ë‹µì‚¬ ì˜ˆì •ì¼</label>
                      <input name="s_visitDate" type="date" className="form-input" defaultValue={normalizeDate(salesModal.data?.raw?.ë‹µì‚¬ì¼) || (dailyModal.isOpen ? dailyModal.dateStr : '')} />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div><label className="form-label">ì‚¬ëª…</label><input name="s_corp" type="text" className="form-input" defaultValue={clean(salesModal.data?.raw?.ì˜ì—…ìì‚¬ëª…) || ''} required /></div>
                      <div><label className="form-label">ì˜ì—…ì</label><input name="s_staff" type="text" className="form-input" defaultValue={clean(salesModal.data?.raw?.ì˜ì—…ìì„±í•¨) || ''} required /></div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div><label className="form-label">ê³ ê°ëª…</label><input name="s_customer" type="text" className="form-input" defaultValue={salesModal.data?.title || ''} required /></div>
                      <div><label className="form-label">ì—°ë½ì²˜</label><input name="s_phone" type="text" className="form-input" defaultValue={clean(salesModal.data?.raw?.ì—°ë½ì²˜) || ''} /></div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div><label className="form-label">êµ¬ë¶„</label><select name="s_type" className="form-input" defaultValue={clean(salesModal.data?.raw?.ê³„ì•½êµ¬ë¶„) || 'ì„ ë¶„ì–‘'}><option>ì„ ë¶„ì–‘</option><option>ì¥ë¡€ì•ˆì¹˜</option></select></div>
                      <div><label className="form-label">ìƒíƒœ</label><select name="s_status" className="form-input text-blue-600" defaultValue={clean(salesModal.data?.status) || 'ìƒë‹´ í›„ ëŒ€ê¸°'}><option>ìƒë‹´ í›„ ëŒ€ê¸°</option><option>ë‹µì‚¬ëŒ€ê¸°</option><option>ë‹µì‚¬ì™„ë£Œ</option><option className="text-red-500">ì•ˆì¹˜í™•ì •</option><option>ì·¨ì†Œ</option></select></div>
                  </div>
                  <div className="input-group"><label className="form-label text-red-500">ì•ˆì¹˜ í™•ì •ì¼</label><input name="s_confirmDate" type="date" className="form-input bg-red-50 border-red-200" defaultValue={normalizeDate(salesModal.data?.raw?.ì•ˆì¹˜í™•ì •ì¼) || ''} /></div>
                  <div className="input-group"><label className="form-label">ë¹„ê³  ë©”ëª¨</label><textarea name="s_memo" className="form-input min-h-[80px]" defaultValue={clean(salesModal.data?.raw?.ë¹„ê³  || salesModal.data?.raw?.ë¹„ê³ ë©”ëª¨)}></textarea></div>
                  <div className="flex gap-2 pt-2">
                      {salesModal.data && <button type="button" onClick={() => deleteSales(salesModal.data.id)} className="flex-1 py-3 bg-slate-200 text-slate-600 font-bold rounded-xl text-xs hover:bg-slate-300">ì‚­ì œ/ë³´ê´€</button>}
                      <button type="submit" className="flex-[2] py-3 bg-blue-600 text-white font-black rounded-xl text-sm hover:bg-blue-700 transition shadow-lg">DB ì €ì¥</button>
                  </div>
              </form>
          </Modal>

          <Modal isOpen={schModal.isOpen} onClose={()=>setSchModal({isOpen:false, data:null})} title={schModal.data ? "ğŸŸ¢ ì•ˆì¹˜ ì¼ì • ìˆ˜ì •" : "ğŸŸ¢ ì•ˆì¹˜ ì¼ì • ë“±ë¡"} isNested={true}>
              <form onSubmit={saveSchedule} className="space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                      <div><label className="form-label">ì•ˆì¹˜ì¼</label><input name="sch_date" type="date" className="form-input" defaultValue={normalizeDate(schModal.data?.raw?.ì•ˆì¹˜ì¼) || (dailyModal.isOpen ? dailyModal.dateStr : '')} required /></div>
                      <div><label className="form-label">ê³„ì•½ë²ˆí˜¸</label><input name="sch_no" type="text" className="form-input" defaultValue={clean(schModal.data?.raw?.ê³„ì•½ë²ˆí˜¸) || ''} /></div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div><label className="form-label">ê³ ì¸ëª…</label><input name="sch_name" type="text" className="form-input" defaultValue={clean(schModal.data?.raw?.ê³ ì¸ëª…) || ''} required /></div>
                      <div><label className="form-label">ê³„ì•½ì</label><input name="sch_contractor" type="text" className="form-input" defaultValue={clean(schModal.data?.raw?.ê³„ì•½ì) || ''} /></div>
                  </div>
                  <div className="input-group">
                      <label className="form-label text-blue-600">ìœ„ì¹˜ì •ë³´ (ì§€ë„ ì—°ë™)</label>
                      <div className="flex gap-2">
                        <input type="text" className="form-input bg-slate-200 text-slate-500 cursor-not-allowed flex-[2] text-xs" readOnly value={selectedLocBase} placeholder="ìš°ì¸¡ ì§€ë„ì„ íƒ ë²„íŠ¼ í´ë¦­" />
                        <div className="relative flex-[1]"><input type="number" className="form-input pr-5 text-center text-xs" placeholder="ê´‘ì¤‘" value={gwangjung} onChange={e => setGwangjung(e.target.value)} /><span className="absolute right-2 top-1/2 -translate-y-1/2 font-black text-slate-400 text-xs">ë²ˆ</span></div>
                        <button type="button" onClick={() => setMapSelectorOpen(true)} className="px-3 bg-slate-800 text-white rounded-lg font-bold text-xs shadow-md">ì§€ë„ì„ íƒ</button>
                      </div>
                  </div>
                  <div className="input-group"><label className="form-label">ë¹„ê³ </label><textarea name="sch_note" className="form-input min-h-[80px]" defaultValue={clean(schModal.data?.raw?.ë¹„ê³ )}></textarea></div>
                  <div className="flex gap-2 pt-2">
                      {schModal.data && <button type="button" onClick={() => deleteSchedule(schModal.data.id)} className="flex-1 py-3 bg-slate-200 text-slate-600 font-bold rounded-xl text-xs hover:bg-slate-300">ì‚­ì œ/ë³´ê´€</button>}
                      <button type="submit" className="flex-[2] py-3 bg-emerald-600 text-white font-black rounded-xl text-sm hover:bg-emerald-700 transition shadow-lg">DB ì €ì¥</button>
                  </div>
              </form>
          </Modal>

          <MapSelectorModal isOpen={mapSelectorOpen} onClose={() => setMapSelectorOpen(false)} layoutData={layoutData} onSelectLocation={(loc) => { setSelectedLocBase(loc); setMapSelectorOpen(false); }} />
        </div>
      );
    }

    // ğŸ“ˆ MODULE 4: Stats View
    function StatsView() {
      const [events, setEvents] = useState([]);
      const [currentDate, setCurrentDate] = useState(new Date());
      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      const [detailModal, setDetailModal] = useState({ isOpen: false, month: '', items: [] });

      useEffect(() => {
        const fetchEvents = async () => {
          try {
            const burRes = await supabaseClient.from('burial_schedule').select('*');
            const bEvs = (burRes.data || []).map(b => ({ id: b.id, type:'burial', date:normalizeDate(b.ì•ˆì¹˜ì¼), raw:b }));
            setEvents(bEvs);
          } catch(e) {}
        };
        fetchEvents();
      }, []);

      const calculateTrendLine = (dataPoints) => {
          let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
          const n = dataPoints.length;
          if (n === 0) return [];
          dataPoints.forEach((y, x) => { sumX += x; sumY += y; sumXY += x * y; sumX2 += x * x; });
          const m = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX) || 0;
          const b = (sumY - m * sumX) / n || 0;
          return dataPoints.map((_, x) => m * x + b);
      };

      useEffect(() => {
        if (!chartRef.current || events.length === 0) return;
        let labels = []; let dataCounts = [];
        
        for (let i = 15; i >= 0; i--) {
            let d = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
            let y = d.getFullYear(); let m = String(d.getMonth() + 1).padStart(2, '0'); 
            let key = `${y}-${m}`;
            let uniqueBurials = new Set();
            events.forEach((ev, idx) => { if (ev.type === 'burial' && ev.date && ev.date.startsWith(key)) { uniqueBurials.add(clean(ev.raw.ê³„ì•½ë²ˆí˜¸) ? clean(ev.raw.ê³„ì•½ë²ˆí˜¸) : `indiv_${idx}`); } });
            labels.push(`${String(y).substring(2)}-${m}`); dataCounts.push(uniqueBurials.size);
        }
        
        const past15MonthsData = dataCounts.slice(0, 15);
        const longTrendPast = calculateTrendLine(past15MonthsData);
        const mLong = longTrendPast.length > 1 ? longTrendPast[1] - longTrendPast[0] : 0;
        const longTrend = [...longTrendPast, longTrendPast[longTrendPast.length-1] + mLong];

        const past6MonthsData = dataCounts.slice(9, 15);
        const shortTrendPast = calculateTrendLine(past6MonthsData);
        const mShort = shortTrendPast.length > 1 ? shortTrendPast[1] - shortTrendPast[0] : 0;
        const shortTrendRaw = [...shortTrendPast, shortTrendPast[shortTrendPast.length-1] + mShort];
        
        const shortTrend = new Array(16).fill(null);
        shortTrend.splice(9, 7, ...shortTrendRaw);

        if (chartInstance.current) chartInstance.current.destroy();
        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: labels, 
                datasets: [
                    { type: 'line', label: 'ë‹¨ê¸° ì¶”ì„¸ì„  (ê³¼ê±° 6ê°œì›”)', data: shortTrend, borderColor: '#ef4444', borderWidth: 3, borderDash: [3, 3], fill: false, pointRadius: 0, datalabels: { display: false } },
                    { type: 'line', label: 'ì¥ê¸° ì¶”ì„¸ì„  (ê³¼ê±° 15ê°œì›”)', data: longTrend, borderColor: '#3b82f6', borderWidth: 2, borderDash: [5, 5], fill: false, pointRadius: 0, datalabels: { display: false } },
                    { type: 'bar', label: 'ì•ˆì¹˜ê±´ìˆ˜', data: dataCounts, backgroundColor: '#2E7D32', borderRadius: 4 }
                ] 
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                layout: { padding: { top: 20 } },
                plugins: { legend: { display: true, position: 'bottom' }, datalabels: { anchor: 'end', align: 'end', color: '#333', font: { weight: 'bold', size: 10 }, formatter: (v, ctx) => ctx.datasetIndex === 2 && v > 0 ? v : "" } },
                scales: { y: { beginAtZero: true, grace: '10%', ticks: { stepSize: 1 } }, x: { ticks: { font: { size: 9 } } } },
                onClick: (e, activeElements) => {
                    if (activeElements.length > 0) {
                        const idx = activeElements[0].index;
                        const clickedLabel = labels[idx]; 
                        const fullMonth = `20${clickedLabel}`; 
                        const monthEvents = events.filter(ev => ev.type === 'burial' && ev.date && ev.date.startsWith(fullMonth));
                        setDetailModal({ isOpen: true, month: fullMonth, items: monthEvents });
                    }
                }
            }
        });
      }, [events, currentDate]);

      return (
        <div className="space-y-4 max-w-7xl mx-auto flex flex-col w-full relative mb-10">
          <div className="bg-white rounded-2xl shadow border border-slate-200 p-6">
              <h3 className="text-left font-black text-slate-800 text-xl mb-1">ğŸ“Š ì„ í˜• íšŒê·€(Linear Regression) ê¸°ë°˜ ì•ˆì¹˜ ëª¨ë©˜í…€ ë¶„ì„</h3>
              <div className="bg-slate-50 border border-slate-200 p-3 rounded-lg mb-4 text-xs font-bold text-slate-600 leading-relaxed">
                  ğŸ’¡ <span className="text-blue-600">ì¥ê¸° ì¶”ì„¸ì„ (íŒŒë€ìƒ‰)</span>ì´ ê¾¸ì¤€íˆ ìš°ìƒí–¥í•˜ë”ë¼ë„, <span className="text-red-500">ë‹¨ê¸° 6ê°œì›” ì¶”ì„¸ì„ (ë¹¨ê°„ìƒ‰)</span>ì´ ê·¸ ì•„ë˜ë¡œ êº¾ì—¬ ìˆë‹¤ë©´ ìµœê·¼ ë°˜ë…„ ë™ì•ˆì˜ ì„±ì¥ ëª¨ë©˜í…€ì´ ë‘”í™”ë˜ê³  ìˆë‹¤ëŠ” ì¦‰ê°ì ì¸ ê²½ê³ (Warning) ì‹ í˜¸ì…ë‹ˆë‹¤. (â€» ì™œê³¡ ë°©ì§€ë¥¼ ìœ„í•´ ë³€ë™ ì¤‘ì¸ ë‹¹ì›” ë°ì´í„°ëŠ” ì¶”ì„¸ì„  ê³„ì‚°ì—ì„œ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.)
              </div>
              <div className="w-full h-[400px] relative cursor-pointer">
                  <canvas ref={chartRef}></canvas>
              </div>
          </div>

          <Modal isOpen={detailModal.isOpen} onClose={()=>setDetailModal({isOpen:false, month:'', items:[]})} title={`ğŸ“… ${detailModal.month} ì•ˆì¹˜ ëª…ë‹¨`}>
             <div className="space-y-2 max-h-[60vh] overflow-y-auto no-scrollbar">
                {detailModal.items.length === 0 ? <p className="text-center p-5 text-slate-400 font-bold">ì•ˆì¹˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p> : detailModal.items.map((ev, i) => (
                    <div key={i} className="p-3 bg-white border border-emerald-200 rounded-xl flex justify-between items-center shadow-sm">
                        <div>
                            <div className="font-black text-slate-800">{ev.raw.ê³ ì¸ëª…} <span className="text-xs text-slate-500 font-bold ml-1">({ev.raw.ê³„ì•½ì})</span></div>
                            <div className="text-[11px] text-blue-600 font-bold">{ev.raw.ìœ„ì¹˜}</div>
                        </div>
                        <div className="text-xs font-bold text-slate-500">{ev.date}</div>
                    </div>
                ))}
             </div>
          </Modal>
        </div>
      );
    }

    // ğŸ§© MODULE 5: HrView
    function HrView() {
      const [loading, setLoading] = useState(true);
      const [hrData, setHrData] = useState([]);
      const [events, setEvents] = useState([]); 
      const [currentDate, setCurrentDate] = useState(new Date());
      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      const [dayModal, setDayModal] = useState({ isOpen: false, dateStr: '', data: {} });

      const fetchHRAndEvents = async () => {
        setLoading(true);
        try {
          const [hrRes, burRes, salRes] = await Promise.all([ supabaseClient.from('hr_management').select('*'), supabaseClient.from('burial_schedule').select('ì•ˆì¹˜ì¼'), supabaseClient.from('status_mgmt').select('ë‹µì‚¬ì¼, í˜„ì¬ìƒíƒœ') ]);
          let cleanHr = (hrRes.data || []).map(r => {
             let d = r.work_date; let n = r.worker_name;
             if(d && n && (d.includes('ê³¼ì¥') || d.includes('íŒ€ì¥') || d.includes('ì‹¤ì¥') || d.includes('ì‚¬ë¬´ì¥') || d.includes('ì°¨ì¥'))) { let temp = d; d = n; n = temp; }
             if (d) { d = d.replace(/ë…„\s*/g, '-').replace(/ì›”\s*/g, '-').replace(/ì¼\s*/g, '').replace(/\s+/g, ''); const parts = d.split('-'); if(parts.length === 3) d = `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`; }
             return { ...r, work_date: d, worker_name: n };
          });
          setHrData(cleanHr);
          const bEvs = (burRes.data || []).map(b => ({ type:'burial', date:normalizeDate(b.ì•ˆì¹˜ì¼) }));
          const sEvs = (salRes.data || []).map(s => ({ type:'sales', date:normalizeDate(s.ë‹µì‚¬ì¼), status:s.í˜„ì¬ìƒíƒœ }));
          setEvents([...bEvs, ...sEvs].filter(e => e.date !== null));
        } catch(e) {}
        setLoading(false);
      };
      useEffect(() => { fetchHRAndEvents(); }, []);

      const getCleanedHR = () => { let map = {}; hrData.forEach(r => { if(r.work_date && r.worker_name) map[`${r.work_date}_${r.worker_name}`] = r.status; }); return map; };

      useEffect(() => {
        if (!chartRef.current) return;
        const pfx = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
        const cln = getCleanedHR();
        let sFull = {}; let sHalf = {}; 
        EMPLOYEES.forEach(e => { sFull[e]=0; sHalf[e]=0; });
        for (const [k, st] of Object.entries(cln)) {
          let [dt, nm] = k.split('_');
          if (dt.startsWith(pfx)) {
            if (['íœ´ë¬´','ì—°ì°¨','ë³‘ê°€'].includes(st)) sFull[nm] = (sFull[nm]||0) + 1;
            else if (['ë°˜ì°¨','ì˜¤ì „ë°˜ì°¨','ì˜¤í›„ë°˜ì°¨','ì¡°í‡´'].includes(st)) sHalf[nm] = (sHalf[nm]||0) + 1;
          }
        }
        const lbls = EMPLOYEES.map(nm => [nm.split(' ')[0], `(íœ´${sFull[nm]}, ë°˜${sHalf[nm]})`]);
        const pts = EMPLOYEES.map(nm => (sFull[nm]*1) + (sHalf[nm]*0.5));
        const ctx = chartRef.current.getContext('2d');
        if(chartInstance.current) chartInstance.current.destroy();
        chartInstance.current = new Chart(ctx, { type: 'bar', data: { labels: lbls, datasets: [{ data: pts, backgroundColor: EMP_COLORS, borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 0.5 } }, x: { ticks: { font: { size: 10 } } } } } });
      }, [hrData, currentDate]);

      const calendarDays = useMemo(() => {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const startDay = new Date(year, month, 1).getDay(), offset = startDay === 0 ? 6 : startDay - 1;
        const lastDate = new Date(year, month + 1, 0).getDate();
        const days = []; const cln = getCleanedHR();
        for (let i = 0; i < offset; i++) days.push(null);
        for (let i = 1; i <= lastDate; i++) {
          const ds = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          let cap = { contract: 0, guide: 0, burial: 0, landscaping: 0 };
          EMPLOYEES.forEach(emp => {
             const st = cln[`${ds}_${emp}`] || 'ì¶œê·¼'; let multiplier = 1;
             if (['ë°˜ì°¨','ì˜¤ì „ë°˜ì°¨', 'ì˜¤í›„ë°˜ì°¨', 'ì¡°í‡´'].includes(st)) multiplier = 0.5; else if (['íœ´ë¬´', 'ì—°ì°¨', 'ë³‘ê°€'].includes(st)) multiplier = 0;
             if (EMP_WEIGHTS[emp]) { cap.contract += (EMP_WEIGHTS[emp].contract * multiplier); cap.guide += (EMP_WEIGHTS[emp].guide * multiplier); cap.burial += (EMP_WEIGHTS[emp].burial * multiplier); cap.landscaping += (EMP_WEIGHTS[emp].landscaping * multiplier); }
          });
          const dayEvents = events.filter(e => e.date === ds);
          const burialCount = dayEvents.filter(e => e.type === 'burial').length;
          const salesCount = dayEvents.filter(e => e.type === 'sales' && (e.status === 'ë‹µì‚¬ëŒ€ê¸°' || e.status === 'ë‹µì‚¬ì™„ë£Œ')).length;
          let warnings = [];
          if (cap.contract <= 1) warnings.push('ê³„ì•½'); if (salesCount > 0 && cap.guide <= 2) warnings.push('ì•ˆë‚´'); if (burialCount >= 4 && cap.burial <= 2) warnings.push('ì•ˆì¹˜');
          days.push({ day: i, dateStr: ds, cap, warnings });
        }
        return days;
      }, [currentDate, hrData, events]);

      const handleCellClick = (dateStr) => { const cln = getCleanedHR(); let dayData = {}; EMPLOYEES.forEach(emp => { dayData[emp] = cln[`${dateStr}_${emp}`] || 'ì¶œê·¼'; }); setDayModal({ isOpen: true, dateStr, data: dayData }); };

      const saveHR = async (e) => {
          e.preventDefault(); const dateStr = dayModal.dateStr;
          await supabaseClient.from('hr_management').delete().eq('work_date', dateStr);
          const insertData = EMPLOYEES.map((emp, i) => ({ work_date: dateStr, worker_name: emp, status: e.target[`hr_st_${i}`].value, memo: e.target.hr_note.value }));
          await supabaseClient.from('hr_management').insert(insertData); logAction('ê·¼íƒœê´€ë¦¬', 'ìˆ˜ì •', dateStr, 'ì¼ê´„ ì €ì¥');
          setDayModal({isOpen:false, dateStr:'', data:{}}); fetchHRAndEvents();
      };

      return (
        <div className="space-y-4 max-w-7xl mx-auto flex flex-col w-full">
          <div className="bg-white rounded-2xl shadow border border-slate-200 flex flex-col overflow-hidden">
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
              <div className="flex items-center space-x-4">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="px-3 py-1 bg-white border border-slate-200 rounded-lg font-bold">â—€</button>
                <h2 className="text-xl font-black">{currentDate.getFullYear()}ë…„ {currentDate.getMonth()+1}ì›”</h2>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="px-3 py-1 bg-white border border-slate-200 rounded-lg font-bold">â–¶</button>
              </div>
            </div>
            <div className="bg-slate-50 p-2 md:p-4">
              <div className="w-full flex flex-col border border-slate-200 rounded-xl shadow-sm bg-slate-200 gap-px">
                <div className="grid grid-cols-7 gap-px">{['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].map((d,i)=>(<div key={d} className={`py-2 text-center text-sm font-black bg-white ${i===6?'text-red-500':i===5?'text-blue-500':'text-slate-700'}`}>{d}</div>))}</div>
                <div className="grid grid-cols-7 gap-px">
                  {calendarDays.map((d,i)=>(
                    <div key={i} onClick={()=>d && handleCellClick(d.dateStr)} className={`calendar-cell flex flex-col ${!d?'bg-slate-50 cursor-default':'cursor-pointer'}`}>
                      {d && (
                        <>
                          <div className={`pointer-events-none text-right text-xs font-bold p-1 ${getTodayStr() === d.dateStr ? 'text-white bg-blue-600 inline-block self-end rounded-md px-2' : 'text-slate-500'}`}>{d.day}</div>
                          <div className="pointer-events-none space-y-1 pb-1 flex-1">
                            {EMPLOYEES.map((emp, idx) => {
                               const st = dayModal.data[emp] || getCleanedHR()[`${d.dateStr}_${emp}`];
                               if(st && st !== 'ì¶œê·¼') { return <div key={emp} className="px-1.5 py-0.5 rounded text-[10px] font-bold truncate border pointer-events-none" style={{backgroundColor: ['íœ´ë¬´','ì—°ì°¨','ë³‘ê°€'].includes(st)?EMP_COLORS[idx]:'white', color: ['íœ´ë¬´','ì—°ì°¨','ë³‘ê°€'].includes(st)?'white':EMP_COLORS[idx], borderColor: EMP_COLORS[idx]}}>{emp} {st.includes('ë°˜ì°¨')?st.substring(0,2):''}</div> } return null;
                            })}
                          </div>
                          {d.warnings.length > 0 && <div className="pointer-events-none mt-auto bg-red-100 border border-red-300 text-red-700 text-[10px] font-black rounded p-1 leading-tight tracking-tighter text-center">ğŸš¨ {d.warnings.join(', ')} ë¶€ì¡±</div>}
                        </>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow border border-slate-200 p-4 mb-10">
              <h3 className="text-center font-black text-slate-800 text-sm mb-2">ğŸ“Š ì´ë²ˆ ë‹¬ ê°œì¸ë³„ íœ´ë¬´ í•©ê³„</h3>
              <div className="w-full h-[200px] relative"><canvas ref={chartRef}></canvas></div>
          </div>

          <Modal isOpen={dayModal.isOpen} onClose={()=>setDayModal({isOpen:false, dateStr:'', data:{}})} title={`ğŸ“ ${dayModal.dateStr} ê·¼ë¬´ ìˆ˜ì •`}>
              <form onSubmit={saveHR} className="space-y-3">
                  {EMPLOYEES.map((emp, i) => {
                      const st = dayModal.data[emp] || 'ì¶œê·¼'; let bg = st === 'ì¶œê·¼' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : (['íœ´ë¬´','ì—°ì°¨'].includes(st) ? 'bg-red-50 text-red-600 border-red-200' : 'bg-orange-50 text-orange-600 border-orange-200');
                      return (
                          <div key={emp} className="flex justify-between items-center p-3 border-b border-dashed border-slate-200">
                              <span className="font-bold text-sm" style={{color: EMP_COLORS[i]}}>{emp}</span>
                              <select name={`hr_st_${i}`} className={`p-2 rounded-lg font-bold text-sm outline-none border ${bg}`} defaultValue={st}>
                                  <option value="ì¶œê·¼">ğŸŸ¢ ì¶œê·¼</option><option value="ë°˜ì°¨">ğŸŒ— ë°˜ì°¨ (0.5)</option><option value="ì˜¤ì „ë°˜ì°¨">ğŸŒ— ì˜¤ì „ ë°˜ì°¨ (0.5)</option><option value="ì˜¤í›„ë°˜ì°¨">ğŸŒ“ ì˜¤í›„ ë°˜ì°¨ (0.5)</option><option value="ì¡°í‡´">ğŸ“‰ ì¡°í‡´ (0.5)</option><option value="íœ´ë¬´">ğŸ”´ íœ´ë¬´ (1)</option><option value="ì—°ì°¨">ğŸ”´ ì—°ì°¨ (1)</option>
                              </select>
                          </div>
                      );
                  })}
                  <div className="pt-2"><input name="hr_note" type="text" className="form-input" placeholder="íŠ¹ì´ì‚¬í•­ ë©”ëª¨" /></div>
                  <button type="submit" className="w-full py-3 bg-slate-800 text-white font-black rounded-xl mt-4 hover:bg-slate-700 shadow-lg">ê·¼íƒœ ì €ì¥</button>
              </form>
          </Modal>
        </div>
      );
    }

    // ğŸ§© MODULE 6: FieldView
    function FieldView({ layoutData }) {
      const [loading, setLoading] = useState(true);
      const [data, setData] = useState([]);
      const [allFieldData, setAllFieldData] = useState([]);
      const [area, setArea] = useState('A6/ê°€');
      const [slotModal, setSlotModal] = useState({ isOpen: false, data: null });
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);

      useEffect(() => {
        const fetchField = async () => {
          setLoading(true);
          try { const [areaRes, allRes] = await Promise.all([ supabaseClient.from('field_data').select('*').eq('êµ¬ì—­', area), supabaseClient.from('field_data').select('*') ]); setData(areaRes.data || []); setAllFieldData(allRes.data || []); } catch(e) {}
          setLoading(false);
        };
        fetchField();
      }, [area]);

      useEffect(() => {
         if(searchQuery.trim().length === 0) { setSearchResults([]); return; }
         const q = searchQuery.toLowerCase();
         const res = allFieldData.filter(d => (clean(d.ì„±í•¨).toLowerCase().includes(q)) || (clean(d.ê³„ì•½ì).toLowerCase().includes(q)) || (clean(d.ë©”ëª¨).toLowerCase().includes(q)) );
         setSearchResults(res);
      }, [searchQuery, allFieldData]);

      const renderedGrid = useMemo(() => {
        if (!layoutData || !layoutData[area]) return [];
        const dataMap = {}; data.forEach(item => { if (item.ìœ„ì¹˜_ë²ˆí˜¸) dataMap[item.ìœ„ì¹˜_ë²ˆí˜¸] = item; });
        const comp = layoutData[area]; let finalRows = [];
        if (Array.isArray(comp[0])) finalRows = comp;
        else {
            const flat = []; comp.forEach(item => { if (typeof item === 'string' && item.startsWith('_')) { const count = parseInt(item.substring(1)) || 1; for(let i=0; i<count; i++) flat.push('SPACER'); } else flat.push(item); });
            const config = ROW_CONFIG[area] || [20]; let idx = 0; config.forEach(cnt => { if(idx < flat.length) { finalRows.push(flat.slice(idx, idx + cnt)); idx += cnt; } });
        }
        return finalRows.map((rowSlots, rIdx) => ({
            rowNum: rIdx + 1,
            slots: rowSlots.map((slotId, sIdx) => {
                if (!slotId || slotId === 'SPACER' || (typeof slotId === 'string' && slotId.startsWith('_'))) return { type: 'spacer', id: `spacer-${rIdx}-${sIdx}` };
                return { type: 'data', ...(dataMap[slotId] || { ìœ„ì¹˜_ë²ˆí˜¸: slotId, êµ¬ì—­: area, ê³„ì•½_ìƒíƒœ: 'ë¯¸ë¶„ì–‘' }) };
            })
        }));
      }, [data, area, layoutData]);

      const saveField = async (e) => {
          e.preventDefault();
          const payload = { êµ¬ì—­: area, ìœ„ì¹˜_ë²ˆí˜¸: slotModal.data.ìœ„ì¹˜_ë²ˆí˜¸, ì„±í•¨: nullIfEmpty(e.target.f_name.value), ê³„ì•½_ìƒíƒœ: nullIfEmpty(e.target.f_status.value), ê³„ì•½ì: nullIfEmpty(e.target.f_contractor.value), ê¸°ìˆ˜: nullIfEmpty(e.target.f_units.value), ê°€ê²©: formatMoney(e.target.f_price.value).replace(/[^0-9]/g, ""), ê´€ë¦¬ë¹„: formatMoney(e.target.f_fee.value).replace(/[^0-9]/g, ""), ë©”ëª¨: nullIfEmpty(e.target.f_memo.value) };
          let err;
          if(slotModal.data?.id) { const res = await supabaseClient.from('field_data').update(payload).eq('id', slotModal.data.id); err = res.error; } 
          else { const res = await supabaseClient.from('field_data').insert(payload); err = res.error; }
          if(err) { alert(`ì €ì¥ ì‹¤íŒ¨: ${err.message}`); return; }
          logAction('í˜„ì¥ê´€ë¦¬', 'ìˆ˜ì •', `${area} ${slotModal.data.ìœ„ì¹˜_ë²ˆí˜¸}`, `ìƒíƒœ: ${payload.ê³„ì•½_ìƒíƒœ}`);
          setSlotModal({isOpen:false, data:null}); setLoading(true);
          const [areaRes, allRes] = await Promise.all([ supabaseClient.from('field_data').select('*').eq('êµ¬ì—­', area), supabaseClient.from('field_data').select('*') ]);
          setData(areaRes.data || []); setAllFieldData(allRes.data || []); setLoading(false);
      };

      return (
        <div className="space-y-4 max-w-7xl mx-auto flex flex-col w-full relative mb-10">
          <div className="px-2 pt-2 relative z-[100]">
             <input type="text" placeholder="ğŸ” ê³ ì¸ëª…, ê³„ì•½ì, ë¹„ê³  ê²€ìƒ‰..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} className="w-full p-3 rounded-xl border border-slate-300 shadow-sm text-sm font-bold focus:border-blue-500 focus:outline-none" />
             {searchResults.length > 0 && (
                 <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-xl rounded-xl mt-1 max-h-60 overflow-y-auto z-[110]">
                     {searchResults.map(r => (
                         <div key={r.id} onClick={() => { setArea(r.êµ¬ì—­); setSlotModal({isOpen:true, data:r}); setSearchQuery(''); }} className="p-3 border-b hover:bg-slate-50 cursor-pointer">
                             <div className="font-black text-blue-600">{r.êµ¬ì—­} {r.ìœ„ì¹˜_ë²ˆí˜¸}</div>
                             <div className="text-sm font-bold">ì•ˆì¹˜ì: {clean(r.ì„±í•¨)||'ì—†ìŒ'} | ê³„ì•½ì: {clean(r.ê³„ì•½ì)||'ì—†ìŒ'}</div>
                             <div className="text-xs text-slate-500 truncate">{clean(r.ë©”ëª¨)}</div>
                         </div>
                     ))}
                 </div>
             )}
          </div>
          <div className="w-full bg-[#F8FAFC] sticky top-14 z-[80] pt-1 pb-2 border-b border-slate-200">
             <div className="flex gap-2 overflow-x-auto px-2 custom-scrollbar pb-1" style={{ WebkitOverflowScrolling: 'touch' }}>
               {SECTION_LIST.map(s => ( <button key={s} onClick={() => setArea(s)} className={`flex-none px-4 py-2.5 rounded-t-xl font-bold text-[13px] whitespace-nowrap transition-all border-t border-l border-r ${area === s ? 'bg-white text-blue-600 border-slate-200 translate-y-[1px] shadow-[0_-2px_4px_rgba(0,0,0,0.02)]' : 'bg-slate-100 text-slate-500 border-transparent hover:bg-slate-200'}`}>{s}</button> ))}
             </div>
          </div>
          <div className="bg-white p-4 md:p-8 rounded-b-2xl rounded-tr-2xl shadow-xl border border-slate-200 overflow-auto w-full">
            {loading || Object.keys(layoutData).length === 0 ? ( <div className="flex h-64 items-center justify-center font-black text-slate-300 animate-pulse tracking-widest text-lg">MAP SYNCING...</div> ) : (
              <div className="min-w-max pb-20 pr-20">
                {renderedGrid.map((row, rIdx) => (
                  <div key={rIdx} className="map-row">
                    {row.slots.map((s) => {
                      if (s.type === 'spacer') return <div key={s.id} className="map-slot slot-spacer"></div>;
                      const st = clean(s.ê³„ì•½_ìƒíƒœ) || 'ë¯¸ë¶„ì–‘';
                      const cols = { 'ì•ˆì¹˜':'bg-emerald-700 text-white border-emerald-800', 'ì˜ˆì•½':'bg-amber-300 text-amber-900 border-amber-400', 'í™€ë”©':'bg-rose-600 text-white border-rose-800', 'ë¯¸ë¶„ì–‘':'bg-white text-slate-400 border-slate-300' };
                      return (
                        <div key={s.id || s.ìœ„ì¹˜_ë²ˆí˜¸} onClick={()=>setSlotModal({isOpen:true, data:s})} className={`map-slot ${cols[st] || cols['ë¯¸ë¶„ì–‘']}`}>
                          <div className={`slot-id ${st==='ë¯¸ë¶„ì–‘'?'opacity-50':''}`}>{s.ìœ„ì¹˜_ë²ˆí˜¸}</div>
                          <div className={`slot-name ${st==='ë¯¸ë¶„ì–‘'?'opacity-30':''}`}>{clean(s.ì„±í•¨) || clean(s.ê³„ì•½ì) || 'EMPTY'}</div>
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
            )}
          </div>

          <Modal isOpen={slotModal.isOpen} onClose={()=>setSlotModal({...slotModal, isOpen:false})} title={`ğŸ“ ${slotModal.data?.êµ¬ì—­} ${slotModal.data?.ìœ„ì¹˜_ë²ˆí˜¸}`}>
            {slotModal.data && (
              <form onSubmit={saveField} className="space-y-4">
                <div className="flex justify-between items-center bg-slate-100 p-4 rounded-xl border border-slate-200 shadow-inner">
                  <div className="flex-1 pr-4 border-r border-slate-300"><label className="form-label">ì•ˆì¹˜ì (ì„±í•¨)</label><input name="f_name" type="text" className="form-input bg-white text-lg font-black" defaultValue={clean(slotModal.data.ì„±í•¨)} /></div>
                  <div className="pl-4 w-32"><label className="form-label">í˜„ì¬ ìƒíƒœ</label><select name="f_status" className="form-input bg-white text-blue-600 font-black cursor-pointer" defaultValue={clean(slotModal.data.ê³„ì•½_ìƒíƒœ) || 'ë¯¸ë¶„ì–‘'}><option value="ë¯¸ë¶„ì–‘">ë¯¸ë¶„ì–‘</option><option value="ì˜ˆì•½">ì˜ˆì•½</option><option value="í™€ë”©">í™€ë”©</option><option value="ì•ˆì¹˜">ì•ˆì¹˜</option></select></div>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div><label className="form-label">ê³„ì•½ì</label><input name="f_contractor" type="text" className="form-input" defaultValue={clean(slotModal.data.ê³„ì•½ì)} /></div>
                  <div><label className="form-label">ê¸°ìˆ˜</label><div className="relative"><input name="f_units" type="number" className="form-input pr-8" defaultValue={clean(slotModal.data.ê¸°ìˆ˜)} /><span className="absolute right-3 top-1/2 -translate-y-1/2 font-black text-slate-400">ê¸°</span></div></div>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div><label className="form-label text-amber-600">ë¶„ì–‘ê°€</label><input name="f_price" type="text" className="form-input bg-amber-50 border-amber-200 text-amber-700" defaultValue={formatMoney(slotModal.data.ê°€ê²©)} /></div>
                  <div><label className="form-label text-amber-600">ê´€ë¦¬ë¹„ (ì—°)</label><input name="f_fee" type="text" className="form-input bg-amber-50 border-amber-200 text-amber-700" defaultValue={formatMoney(slotModal.data.ê´€ë¦¬ë¹„)} /></div>
                </div>
                <div><label className="form-label">ë¹„ê³  (í˜„ì¥ ë©”ëª¨)</label><textarea name="f_memo" className="form-input min-h-[80px]" defaultValue={clean(slotModal.data.ë©”ëª¨)}></textarea></div>
                <div className="pt-2"><button type="submit" className="w-full py-3 bg-blue-600 text-white font-black rounded-xl text-sm shadow-lg">ì§€ë„ DB ë°˜ì˜</button></div>
              </form>
            )}
          </Modal>
        </div>
      );
    }

    // ğŸ§© MODULE 7: JAKE WORKSPACE
    function ProjectsWorkspace() {
       const [projects, setProjects] = useState([]);
       const [modal, setModal] = useState({ isOpen: false, data: null, activeTab: 'info' });

       const fetchProjects = async () => {
           try { const res = await supabaseClient.from('project_db').select('*').order('id', {ascending: false}); if(res.data) setProjects(res.data); } catch(e) {}
       };
       useEffect(() => { fetchProjects(); }, []);

       const saveProject = async (e) => {
           e.preventDefault();
           const payload = { title: nullIfEmpty(e.target.p_title.value), personnel: nullIfEmpty(e.target.p_manager.value), end_date: nullIfEmpty(e.target.p_deadline.value), status: nullIfEmpty(e.target.p_status.value) };
           let err;
           if(modal.data?.id) { const res = await supabaseClient.from('project_db').update(payload).eq('id', modal.data.id); err = res.error; } 
           else { payload.id = 'proj-' + Date.now(); const res = await supabaseClient.from('project_db').insert(payload); err = res.error; }
           if(err) { alert("ì¶”ê°€ ì‹¤íŒ¨: " + err.message); return; }
           setModal({isOpen:false, data:null}); fetchProjects();
       };
       const moveProject = async (id, newStatus) => { await supabaseClient.from('project_db').update({status: newStatus}).eq('id', id); fetchProjects(); };

       return (
          <div className="bg-white p-4 sm:p-8 rounded-2xl shadow border border-slate-200 min-h-[50vh] w-full mb-10">
             <div className="flex justify-between items-center mb-6 border-b pb-4">
                <h2 className="text-xl sm:text-2xl font-black text-slate-800">ğŸš€ í”„ë¡œì íŠ¸ ì¹¸ë°˜ ë³´ë“œ</h2>
                <button onClick={() => setModal({isOpen:true, data:null, activeTab:'info'})} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow text-sm">+ íƒœìŠ¤í¬ ì¶”ê°€</button>
             </div>
             <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {['To Do', 'Doing', 'Done'].map(status => {
                    const list = projects.filter(p => p.status === status);
                    const colors = { 'To Do':'bg-slate-50 border-slate-200 text-slate-600', 'Doing':'bg-indigo-50 border-indigo-100 text-indigo-800', 'Done':'bg-emerald-50 border-emerald-100 text-emerald-800' };
                    return (
                        <div key={status} className={`p-4 rounded-xl border min-h-[300px] ${colors[status]}`}>
                           <h3 className="font-black mb-3 flex justify-between">{status} <span className="bg-white px-2 rounded-full shadow-sm">{list.length}</span></h3>
                           <div className="space-y-3">
                               {list.map(p => (
                                   <div key={p.id} className="bg-white p-3 rounded-lg shadow-sm border border-slate-100 hover:shadow-md transition">
                                      <p onClick={()=>setModal({isOpen:true, data:p, activeTab:'info'})} className="font-bold text-sm text-slate-800 cursor-pointer hover:text-indigo-600">{p.title}</p>
                                      <div className="text-[10px] text-slate-500 mt-2 flex justify-between items-center">
                                          <span>ë§ˆê°: {p.end_date || '-'} | ë‹´ë‹¹: {p.personnel}</span>
                                          <div className="space-x-2">
                                            {status === 'To Do' && <button onClick={()=>moveProject(p.id, 'Doing')} className="text-indigo-600 font-black">ì‹œì‘ â–¶</button>}
                                            {status === 'Doing' && <button onClick={()=>moveProject(p.id, 'Done')} className="text-emerald-600 font-black">ì™„ë£Œ âœ”ï¸</button>}
                                          </div>
                                      </div>
                                   </div>
                               ))}
                           </div>
                        </div>
                    )
                })}
             </div>

             <Modal isOpen={modal.isOpen} onClose={()=>setModal({isOpen:false, data:null})} title={modal.data ? "í”„ë¡œì íŠ¸ ìƒì„¸ ê´€ë¦¬" : "ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±"} isNested={true}>
                 {modal.data && (
                     <div className="flex border-b mb-4">
                         <button onClick={()=>setModal({...modal, activeTab:'info'})} className={`flex-1 py-2 font-bold text-sm ${modal.activeTab==='info'?'border-b-2 border-indigo-600 text-indigo-600':'text-slate-400'}`}>ìƒì„¸ì •ë³´</button>
                         <button onClick={()=>setModal({...modal, activeTab:'tasks'})} className={`flex-1 py-2 font-bold text-sm ${modal.activeTab==='tasks'?'border-b-2 border-indigo-600 text-indigo-600':'text-slate-400'}`}>ì„¸ë¶€ í• ì¼(WBS)</button>
                         <button onClick={()=>setModal({...modal, activeTab:'logs'})} className={`flex-1 py-2 font-bold text-sm ${modal.activeTab==='logs'?'border-b-2 border-indigo-600 text-indigo-600':'text-slate-400'}`}>íˆìŠ¤í† ë¦¬</button>
                     </div>
                 )}
                 {modal.activeTab === 'info' && (
                     <form onSubmit={saveProject} className="space-y-4">
                         <div className="input-group"><label className="form-label">í”„ë¡œì íŠ¸ ëª…</label><input name="p_title" type="text" className="form-input" defaultValue={modal.data?.title} required /></div>
                         <div className="grid grid-cols-2 gap-3">
                             <div className="input-group"><label className="form-label">ë‹´ë‹¹ì</label><input name="p_manager" type="text" className="form-input" defaultValue={modal.data?.personnel} /></div>
                             <div className="input-group"><label className="form-label">ë§ˆê°ì¼</label><input name="p_deadline" type="date" className="form-input" defaultValue={modal.data?.end_date} /></div>
                         </div>
                         <div className="input-group"><label className="form-label">ì§„í–‰ ìƒíƒœ</label><select name="p_status" className="form-input" defaultValue={modal.data?.status || 'To Do'}><option>To Do</option><option>Doing</option><option>Done</option></select></div>
                         <div className="flex pt-2"><button type="submit" className="w-full py-3 bg-indigo-600 text-white font-black rounded-xl text-sm shadow-lg">ì €ì¥</button></div>
                     </form>
                 )}
                 {modal.activeTab === 'tasks' && <div className="text-center p-10 text-slate-400 font-bold">ì„¸ë¶€ í• ì¼ ì—°ë™ ëª¨ë“ˆ (ê°œë°œ ì¤‘)</div>}
                 {modal.activeTab === 'logs' && <div className="text-center p-10 text-slate-400 font-bold">í”„ë¡œì íŠ¸ íˆìŠ¤í† ë¦¬ ì—°ë™ ëª¨ë“ˆ (ê°œë°œ ì¤‘)</div>}
             </Modal>
          </div>
       )
    }

    function MinutesWorkspace() {
       const [minutes, setMinutes] = useState([]);
       const [issues, setIssues] = useState([]);
       const [events, setEvents] = useState([]); 
       const [modal, setModal] = useState({ isOpen: false, data: null });
       
       const [issueFilter, setIssueFilter] = useState('ì „ì²´');
       const [toggleIssues, setToggleIssues] = useState(false);
       const [toggleEvents, setToggleEvents] = useState(false);
       
       const [salesModal, setSalesModal] = useState({ isOpen: false, data: null });
       const [schModal, setSchModal] = useState({ isOpen: false, data: null });
       const [targetDate, setTargetDate] = useState(getTodayStr()); 
       
       const fetchData = async () => {
           try {
               const [mRes, iRes, bRes, sRes] = await Promise.all([
                   supabaseClient.from('meeting_logs').select('*').order('meeting_date', {ascending: false}),
                   supabaseClient.from('issue_db').select('*'),
                   supabaseClient.from('burial_schedule').select('*'),
                   supabaseClient.from('status_mgmt').select('*')
               ]);
               if(mRes.data) setMinutes(mRes.data);
               if(iRes.data) setIssues(iRes.data);
               const bEvs = (bRes.data || []).map(b => ({ id: b.id, type:'burial', date:normalizeDate(b.ì•ˆì¹˜ì¼), raw:b }));
               const sEvs = (sRes.data || []).map(s => ({ id: s.id, type:'sales', date:normalizeDate(s.ë‹µì‚¬ì¼), raw:s }));
               setEvents([...bEvs, ...sEvs]);
           } catch(e) {}
       };
       useEffect(() => { fetchData(); }, []);

       const targetEvents = useMemo(() => {
           return {
               burial: events.filter(e => e.type === 'burial' && e.date === targetDate),
               sales: events.filter(e => e.type === 'sales' && e.date === targetDate)
           };
       }, [events, targetDate]);

       const saveMinute = async (e) => {
           e.preventDefault();
           const payload = { meeting_date: nullIfEmpty(e.target.m_date.value), topic: nullIfEmpty(e.target.m_title.value), content: nullIfEmpty(e.target.m_content.value), participants: nullIfEmpty(e.target.m_part.value), weather: nullIfEmpty(e.target.m_wea.value) };
           if(modal.data?.id) await supabaseClient.from('meeting_logs').update(payload).eq('id', modal.data.id);
           else await supabaseClient.from('meeting_logs').insert(payload);
           setModal({isOpen:false, data:null}); fetchData();
       };

       const filteredIssues = useMemo(() => {
           if(issueFilter === 'ì „ì²´') return issues;
           return issues.filter(i => i.status === issueFilter);
       }, [issues, issueFilter]);

       return (
          <div className="bg-white p-4 sm:p-8 rounded-2xl shadow border border-slate-200 min-h-[50vh] w-full mt-4 mb-10">
             <div className="flex justify-between items-center mb-6 border-b pb-4">
                <h2 className="text-xl sm:text-2xl font-black text-slate-800">ğŸ“ íšŒì˜ë¡ ê´€ë¦¬</h2>
                <button onClick={() => {setTargetDate(getTodayStr()); setModal({isOpen:true, data:null});}} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow text-sm hover:bg-indigo-700 transition">+ ìƒˆ íšŒì˜ë¡</button>
             </div>
             <div className="space-y-3">
                 {minutes.length === 0 ? <p className="text-center text-slate-400 py-10 font-bold">ë“±ë¡ëœ íšŒì˜ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p> : minutes.map(m => (
                     <div key={m.id} onClick={() => {setTargetDate(m.meeting_date || getTodayStr()); setModal({isOpen:true, data:m});}} className="p-4 border border-slate-200 rounded-xl hover:bg-indigo-50 transition cursor-pointer">
                         <div className="text-xs text-indigo-500 font-bold mb-1">{m.meeting_date} | ì°¸ì—¬: {m.participants||'ë¯¸ê¸°ì¬'}</div>
                         <div className="font-black text-slate-800">{m.topic}</div>
                     </div>
                 ))}
             </div>

             <Modal isOpen={modal.isOpen} onClose={()=>setModal({isOpen:false, data:null})} title={modal.data ? "íšŒì˜ë¡ ìƒì„¸" : "ìƒˆ íšŒì˜ë¡ ì‘ì„±"} fullScreen={true} isNested={false}>
                 <div className="max-w-4xl mx-auto py-6 pb-20">
                     <div className="bg-indigo-50 p-4 rounded-xl mb-4 border border-indigo-100">
                        <div className="flex justify-between items-center cursor-pointer" onClick={() => setToggleEvents(!toggleEvents)}>
                            <span className="font-black text-indigo-800">ğŸ“Š {targetDate} ì¼ì • ìš”ì•½ (í´ë¦­ ì‹œ ì›ë³¸ ì°½ ì˜¤í”ˆ)</span>
                            <div className="flex items-center gap-3">
                               <span className="text-xs font-bold bg-indigo-200 text-indigo-800 px-2 py-0.5 rounded">ì•ˆì¹˜ {targetEvents.burial.length}ê±´ / ë‹µì‚¬ {targetEvents.sales.length}ê±´</span>
                               <span className="text-sm text-indigo-600">{toggleEvents ? 'â–²' : 'â–¼'}</span>
                            </div>
                        </div>
                        {toggleEvents && (
                            <div className="mt-4 pt-4 border-t border-indigo-200 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 className="font-bold text-xs text-indigo-700 mb-2">ğŸŸ¢ ì•ˆì¹˜ ë¦¬ìŠ¤íŠ¸</h4>
                                    <ul className="space-y-1">
                                        {targetEvents.burial.length===0 && <li className="text-xs text-slate-500">ì¼ì • ì—†ìŒ</li>}
                                        {targetEvents.burial.map((b,i) => <li key={i} onClick={()=>setSchModal({isOpen:true, data:{raw:b.raw, ...b.raw}})} className="text-sm bg-white p-2 rounded border border-indigo-100 shadow-sm cursor-pointer hover:bg-indigo-50"><span className="font-black">{b.raw.ê³ ì¸ëª…}</span> ({b.raw.ìœ„ì¹˜})</li>)}
                                    </ul>
                                </div>
                                <div>
                                    <h4 className="font-bold text-xs text-amber-700 mb-2">ğŸŸ¡ ë‹µì‚¬/ì˜ì—… ë¦¬ìŠ¤íŠ¸</h4>
                                    <ul className="space-y-1">
                                        {targetEvents.sales.length===0 && <li className="text-xs text-slate-500">ì¼ì • ì—†ìŒ</li>}
                                        {targetEvents.sales.map((s,i) => <li key={i} onClick={()=>setSalesModal({isOpen:true, data:{raw:s.raw, ...s.raw}})} className="text-sm bg-white p-2 rounded border border-indigo-100 shadow-sm cursor-pointer hover:bg-indigo-50"><span className="font-black">{s.raw['ê³ ê°_ê³ ì¸_ëª…']||s.raw.ê³ ê°ëª…||'ì´ë¦„ì—†ìŒ'}</span> <span className="text-xs text-slate-500">ë‹´ë‹¹:{s.raw.ì˜ì—…ìì‚¬ëª…}/{s.raw.ì˜ì—…ìì„±í•¨}</span></li>)}
                                    </ul>
                                </div>
                            </div>
                        )}
                     </div>
                     <div className="bg-slate-50 p-4 rounded-xl mb-6 border border-slate-200">
                        <div className="flex justify-between items-center cursor-pointer" onClick={() => setToggleIssues(!toggleIssues)}>
                            <span className="font-black text-slate-800">ğŸ¯ ë¯¸í•´ê²° í˜„ì•ˆ(ì´ìŠˆ) ëª©ë¡</span>
                            <span className="text-sm text-slate-500">{toggleIssues ? 'â–² ë‹«ê¸°' : 'â–¼ ì—´ê¸°'}</span>
                        </div>
                        {toggleIssues && (
                            <div className="mt-4 pt-4 border-t border-slate-200">
                                <div className="flex gap-2 mb-3">
                                    {['ì „ì²´', 'ì‹œì‘ì „', 'ì§„í–‰ì¤‘', 'ë³´ë¥˜', 'ì™„ë£Œ'].map(f => ( <button key={f} type="button" onClick={()=>setIssueFilter(f)} className={`px-3 py-1 rounded-full text-xs font-bold transition ${issueFilter === f ? 'bg-slate-800 text-white' : 'bg-white border border-slate-300 text-slate-600 hover:bg-slate-100'}`}>{f}</button> ))}
                                </div>
                                <div className="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                                    {filteredIssues.map(i => (
                                        <div key={i.id} className="p-3 bg-white border border-slate-200 rounded-lg text-sm flex justify-between items-center shadow-sm">
                                            <span className="font-bold text-slate-700">{i.title}</span>
                                            <span className={`text-[10px] px-2 py-1 rounded font-black ${i.status==='ì™„ë£Œ'?'bg-emerald-100 text-emerald-700':i.status==='ë³´ë¥˜'?'bg-red-100 text-red-700':'bg-amber-100 text-amber-700'}`}>{i.status}</span>
                                        </div>
                                    ))}
                                    {filteredIssues.length === 0 && <p className="text-sm text-slate-400 p-4 text-center">í•´ë‹¹ ìƒíƒœì˜ í˜„ì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>}
                                </div>
                            </div>
                        )}
                     </div>
                     <form onSubmit={saveMinute} className="space-y-4">
                         <div className="grid grid-cols-2 gap-4">
                             <div className="input-group"><label className="form-label">íšŒì˜ ì¼ì (ë³€ê²½ ì‹œ ìœ„ ìš”ì•½ ì—°ë™)</label><input name="m_date" type="date" className="form-input text-blue-600" value={targetDate} onChange={e=>setTargetDate(e.target.value)} required /></div>
                             <div className="input-group"><label className="form-label">ë‚ ì”¨</label><input name="m_wea" type="text" className="form-input" defaultValue={modal.data?.weather} /></div>
                         </div>
                         <div className="input-group"><label className="form-label">ì°¸ì—¬ì</label><input name="m_part" type="text" className="form-input" defaultValue={modal.data?.participants} /></div>
                         <div className="input-group"><label className="form-label">ì•ˆê±´ / ì œëª©</label><input name="m_title" type="text" className="form-input text-lg py-3" defaultValue={modal.data?.topic} required /></div>
                         <div className="input-group"><label className="form-label">íšŒì˜ ë‚´ìš© (STT / ë§ˆí¬ë‹¤ìš´ ì…ë ¥)</label><textarea name="m_content" className="form-input min-h-[400px] font-mono text-sm leading-relaxed bg-slate-50 focus:bg-white" defaultValue={modal.data?.content} placeholder="í´ë¡œë°”ë…¸íŠ¸/ChatGPT STT ìš”ì•½ ê²°ê³¼ë¥¼ ì´ê³³ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea></div>
                         <div className="flex pt-4"><button type="submit" className="w-full py-4 bg-indigo-600 text-white font-black rounded-xl text-lg shadow-xl hover:bg-indigo-700 hover:-translate-y-1 transition">ğŸ’¾ íšŒì˜ë¡ ì˜êµ¬ ì €ì¥</button></div>
                     </form>
                 </div>
             </Modal>
             <Modal isOpen={schModal.isOpen} onClose={()=>setSchModal({isOpen:false, data:null})} title="ğŸŸ¢ ì•ˆì¹˜ ì¼ì • ë·°" isNested={true}>
                 <div className="space-y-4 p-4 text-center"><p className="font-bold text-slate-600">ì´ê³³ì—ì„œ ì¼ì •ì„ ì§ì ‘ ìˆ˜ì •í•˜ê³  ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì€ ê°œë°œ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤.</p></div>
             </Modal>
             <Modal isOpen={salesModal.isOpen} onClose={()=>setSalesModal({isOpen:false, data:null})} title="ğŸŸ¡ ë‹µì‚¬ í˜„í™© ë·°" isNested={true}>
                 <div className="space-y-4 p-4 text-center"><p className="font-bold text-slate-600">ì´ê³³ì—ì„œ ì¼ì •ì„ ì§ì ‘ ìˆ˜ì •í•˜ê³  ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì€ ê°œë°œ ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤.</p></div>
             </Modal>
          </div>
       )
    }

    // âœ… ê°ì¸ í˜„í™© (ë”¥ ì„œì¹˜ & ë¹ˆ ë‚ ì§œ ì—ëŸ¬ ì™„ë²½ í”½ìŠ¤)
    function EngravingWorkspace() {
       const [engravings, setEngravings] = useState([]);
       const [modal, setModal] = useState({ isOpen: false, data: null });
       const [viewMode, setViewMode] = useState('folder'); 
       const [currentDate, setCurrentDate] = useState(new Date());
       
       // âœ… ê°ì¸ í˜„í™© ì „ìš© ë”¥ ì„œì¹˜
       const [engSearch, setEngSearch] = useState('');

       const fetchEngravings = async () => {
           try {
               const res = await supabaseClient.from('engraving_mgmt').select('*');
               if(res.data) setEngravings(res.data.filter(e => e.ê³ ì¸ëª… && String(e.ê³ ì¸ëª…).trim() !== ''));
           } catch(e) {}
       };
       useEffect(() => { fetchEngravings(); }, []);

       // ê²€ìƒ‰ í•„í„°ë§ 
       const filteredEngravings = useMemo(() => {
           if(!engSearch.trim()) return engravings;
           const q = engSearch.toLowerCase();
           return engravings.filter(e => 
               String(e.ê³ ì¸ëª…||'').toLowerCase().includes(q) ||
               String(e.ê³„ì•½ë²ˆí˜¸||'').toLowerCase().includes(q) ||
               String(e.ìƒì„¸ì¢Œí‘œ||'').toLowerCase().includes(q) ||
               String(e.ê³„ì•½ì||'').toLowerCase().includes(q) ||
               String(e.ë¹„ê³ ||'').toLowerCase().includes(q)
           );
       }, [engravings, engSearch]);

       const statusWeight = { 'ì ‘ìˆ˜': 1, 'ë””ìì¸ì™„ë£Œ': 2, 'ê°ì¸ì™„ë£Œ': 3, 'ì„¤ì¹˜ì™„ë£Œ': 4 };

       const folderList = useMemo(() => {
           const grouped = filteredEngravings.reduce((acc, item) => {
               const key = clean(item.ê³„ì•½ë²ˆí˜¸) || 'ê³„ì•½ë²ˆí˜¸ ì—†ìŒ';
               if(!acc[key]) acc[key] = []; acc[key].push(item); return acc;
           }, {});
           
           const result = Object.entries(grouped).map(([contract, items]) => {
               const highestUrgency = Math.min(...items.map(i => statusWeight[i.ìƒíƒœ] || 1));
               const repStatus = Object.keys(statusWeight).find(k => statusWeight[k] === highestUrgency) || 'ì ‘ìˆ˜';
               const isDone = highestUrgency === 4;
               const earliestDate = items.reduce((min, i) => (!min || (i.ì•ˆì¹˜_ì˜ˆì •_ì¼ && i.ì•ˆì¹˜_ì˜ˆì •_ì¼ < min)) ? i.ì•ˆì¹˜_ì˜ˆì •_ì¼ : min, null);
               items.sort((a,b) => new Date(b.ì•ˆì¹˜_ì˜ˆì •_ì¼||0) - new Date(a.ì•ˆì¹˜_ì˜ˆì •_ì¼||0));
               return { contract, items, isDone, repStatus, highestUrgency, earliestDate };
           });
           
           result.sort((a,b) => {
               if(a.highestUrgency !== b.highestUrgency) return a.highestUrgency - b.highestUrgency;
               return new Date(b.earliestDate||0) - new Date(a.earliestDate||0);
           });
           return result;
       }, [filteredEngravings]);

       const [expandedFolders, setExpandedFolders] = useState({});
       const toggleFolder = (contract) => setExpandedFolders(prev => ({...prev, [contract]: !prev[contract]}));

       const handleAiParse = () => {
           const text = document.getElementById('ai_text_input').value;
           if(!text) return;
           const extract = (keywords) => {
               for(let kw of keywords) {
                   const regex = new RegExp(`(?:${kw})\\s*[:>\\-\\]]?\\s*([^\\n\\r]+)`);
                   const match = text.match(regex);
                   if(match && match[1].trim()) return match[1].trim();
               }
               return '';
           };

           const parsed = {
               contractNo: extract(['ê³„ì•½ë²ˆí˜¸', 'ê³„ì•½ ë²ˆí˜¸', 'ê´€ë¦¬ë²ˆí˜¸']), name: extract(['ê³ ì¸ëª…', 'ê³ ì¸ ì´ë¦„', 'ì•ˆì¹˜ì', 'ì„±ëª…']),
               contractor: extract(['ê³„ì•½ì', 'ê³„ì•½ìëª…']), loc: extract(['ì•ˆì¹˜ìœ„ì¹˜', 'ìœ„ì¹˜', 'ì•ˆì¹˜ êµ¬ì—­', 'ê³„ì•½ìœ„ì¹˜']),
               gwang: extract(['ê´‘ì¤‘ìœ„ì¹˜', 'ê´‘ì¤‘', 'ì¢Œìš°']), stone: extract(['ì„ì¬ì¢…ë¥˜', 'ì„ì¬', 'ë¹„ì„', 'ê·œê²©']),
               rel: extract(['ì¢…êµ', 'ì¢…êµë§ˆí¬', 'ë§ˆí¬']), mark: extract(['í‘œê¸°', 'í•œìí‘œê¸°', 'í•œì']), date: extract(['ì•ˆì¹˜ì¼', 'ì•ˆì¹˜ì˜ˆì •ì¼', 'ì•ˆì¹˜ì¼ì'])
           };

           if(parsed.contractNo) document.getElementsByName('e_contractNo')[0].value = parsed.contractNo;
           if(parsed.name) document.getElementsByName('e_name')[0].value = parsed.name;
           if(parsed.contractor) document.getElementsByName('e_contractor')[0].value = parsed.contractor;
           if(parsed.loc) document.getElementsByName('e_loc')[0].value = parsed.loc;
           if(parsed.gwang) document.getElementsByName('e_gwang')[0].value = parsed.gwang;
           
           if(parsed.stone) {
              const st = parsed.stone.replace(/\s/g,''); let mapped = "100*70";
              if(st.includes("160")) mapped = "160*100"; else if(st.includes("130")) mapped = "130*80"; else if(st.includes("62")) mapped = "100*62";
              document.getElementsByName('e_stone')[0].value = mapped;
           }
           if(parsed.rel) {
               const r = parsed.rel; let mapped = "ë¬´êµ/ê¸°íƒ€";
               if(r.includes("ê¸°ë…")) mapped = "ê¸°ë…êµ"; else if(r.includes("ì²œì£¼")) mapped = "ì²œì£¼êµ"; else if(r.includes("ë¶ˆêµ")) mapped = "ë¶ˆêµ";
               document.getElementsByName('e_rel')[0].value = mapped;
           }
           if(parsed.mark) document.getElementsByName('e_mark')[0].value = parsed.mark;
           
           if(parsed.date) {
               const dMatch = parsed.date.replace(/[^0-9]/g, '');
               if(dMatch.length === 8) { document.getElementsByName('e_an_date')[0].value = `${dMatch.substring(0,4)}-${dMatch.substring(4,6)}-${dMatch.substring(6,8)}`; } 
               else { const formatted = normalizeDate(parsed.date); if(formatted) document.getElementsByName('e_an_date')[0].value = formatted; }
           }
       };

       const saveEngraving = async (e) => {
           e.preventDefault();
           // âœ… [ì—ëŸ¬ í”½ìŠ¤] ë‚ ì§œì— ë¹ˆì¹¸("")ì´ ë“¤ì–´ê°ˆ ê²½ìš° Postgres DB ì—ëŸ¬ë¥¼ ë§‰ê¸° ìœ„í•´ nullIfEmpty í•¨ìˆ˜ ì ìš©
           const payload = { 
               ì•ˆì¹˜_ì˜ˆì •_ì¼: nullIfEmpty(e.target.e_an_date.value), ìƒì„¸ì¢Œí‘œ: nullIfEmpty(e.target.e_loc.value), ê³ ì¸ëª…: nullIfEmpty(e.target.e_name.value), 
               ìƒë…„ì›”ì¼: nullIfEmpty(e.target.e_birth.value), ìƒ_ìŒì–‘: nullIfEmpty(e.target.e_birth_type.value),
               ì¡¸ë…„ì›”ì¼: nullIfEmpty(e.target.e_death.value), ì¡¸_ìŒì–‘: nullIfEmpty(e.target.e_death_type.value),
               ê³„ì•½ì: nullIfEmpty(e.target.e_contractor.value), ê·œê²©: nullIfEmpty(e.target.e_stone.value), ìƒíƒœ: nullIfEmpty(e.target.e_status.value),
               ê´‘ì¤‘ìœ„ì¹˜: nullIfEmpty(e.target.e_gwang.value), ì¢…êµ: nullIfEmpty(e.target.e_rel.value), í‘œê¸°: nullIfEmpty(e.target.e_mark.value), 
               ë¹„ê³ : nullIfEmpty(e.target.e_memo.value), ê³„ì•½ë²ˆí˜¸: nullIfEmpty(e.target.e_contractNo.value),
               ì‹ ì²­ì„œ: nullIfEmpty(e.target.e_form.value), ê°ì¸: nullIfEmpty(e.target.e_print.value)
           };
           let err;
           
           // âœ… [ì—ëŸ¬ í”½ìŠ¤] ìˆ˜ì •(Update) ì‹œ ê¸°ì¤€ í‚¤ë¥¼ ëª…í™•íˆ ì„¸íŒ…
           if(modal.data?.uid) { 
               const res = await supabaseClient.from('engraving_mgmt').update(payload).eq('uid', modal.data.uid); err = res.error; 
           } else { 
               payload.uid = 'eng-' + Date.now(); const res = await supabaseClient.from('engraving_mgmt').insert(payload); err = res.error; 
           }
           
           if(err) { alert("ì €ì¥ ì‹¤íŒ¨: " + err.message); return; }
           setModal({isOpen:false, data:null}); fetchEngravings();
       };

       const deleteEngraving = async (uid) => {
           if(confirm("ì´ ê°ì¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
               const res = await supabaseClient.from('engraving_mgmt').delete().eq('uid', uid);
               if(res.error) alert("ì‚­ì œ ì‹¤íŒ¨: " + res.error.message);
               else { setModal({isOpen:false, data:null}); fetchEngravings(); }
           }
       };

       const calendarDays = useMemo(() => {
           const year = currentDate.getFullYear(), month = currentDate.getMonth();
           const startDay = new Date(year, month, 1).getDay(), offset = startDay === 0 ? 6 : startDay - 1;
           const lastDate = new Date(year, month + 1, 0).getDate();
           const days = [];
           for (let i = 0; i < offset; i++) days.push(null);
           for (let i = 1; i <= lastDate; i++) {
             const ds = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
             days.push({ day: i, dateStr: ds, dayEvents: filteredEngravings.filter(e => normalizeDate(e.ì•ˆì¹˜_ì˜ˆì •_ì¼) === ds) });
           }
           return days;
       }, [currentDate, filteredEngravings]);

       return (
          <div className="bg-white p-4 sm:p-8 rounded-2xl shadow border border-slate-200 min-h-[50vh] w-full mt-4 mb-10">
             <div className="flex justify-between items-center mb-4 border-b pb-4 flex-wrap gap-4">
                <h2 className="text-xl sm:text-2xl font-black text-slate-800">âš°ï¸ ê°ì¸ ê´€ë¦¬</h2>
                <div className="flex gap-2">
                    <button onClick={() => setViewMode('folder')} className={`px-4 py-2 rounded-lg font-bold text-sm shadow ${viewMode==='folder'?'bg-stone-800 text-white':'bg-white text-slate-600 border'}`}>ğŸ“ í´ë” ë·°</button>
                    <button onClick={() => setViewMode('calendar')} className={`px-4 py-2 rounded-lg font-bold text-sm shadow ${viewMode==='calendar'?'bg-stone-800 text-white':'bg-white text-slate-600 border'}`}>ğŸ“… ë‹¬ë ¥ ë·°</button>
                    <button onClick={() => setModal({isOpen:true, data:null})} className="px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow text-sm hover:bg-blue-700 transition">+ ì‹ ê·œ ì¶”ê°€</button>
                </div>
             </div>

             <div className="mb-6 relative z-10">
                 <input type="text" placeholder="ğŸ” ê³ ì¸ëª…, ê³„ì•½ë²ˆí˜¸, ì•ˆì¹˜ìœ„ì¹˜, ê³„ì•½ì ê²€ìƒ‰..." value={engSearch} onChange={e=>setEngSearch(e.target.value)} className="w-full p-3 rounded-xl border border-stone-200 shadow-sm text-sm font-bold focus:border-stone-500 focus:outline-none" />
             </div>
             
             {viewMode === 'folder' && (
                 <div className="space-y-3">
                     {folderList.length === 0 && <div className="text-center p-10 text-slate-400 font-bold">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                     {folderList.map(folder => {
                         const statusCols = { 'ì ‘ìˆ˜':'bg-red-100 text-red-700', 'ë””ìì¸ì™„ë£Œ':'bg-amber-100 text-amber-700', 'ê°ì¸ì™„ë£Œ':'bg-blue-100 text-blue-700', 'ì„¤ì¹˜ì™„ë£Œ':'bg-slate-200 text-slate-500' };
                         const badgeCol = statusCols[folder.repStatus] || 'bg-slate-100';

                         return (
                         <div key={folder.contract} className="border border-slate-200 rounded-xl overflow-hidden bg-white shadow-sm">
                             <div onClick={() => toggleFolder(folder.contract)} className="p-4 cursor-pointer flex justify-between items-center hover:bg-slate-50 transition">
                                 <div className="flex items-center gap-3 flex-wrap">
                                     <span className="font-black text-slate-800 text-lg">ğŸ“ ê³„ì•½ {folder.contract}</span>
                                     <div className="flex gap-1 flex-wrap">
                                         {folder.items.map((it, idx) => <span key={idx} className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded-full text-[10px] font-bold border border-slate-200">{it.ê³ ì¸ëª…}</span>)}
                                     </div>
                                 </div>
                                 <div className="flex items-center gap-3">
                                     <span className={`text-[11px] px-3 py-1 rounded-full font-black tracking-tight ${badgeCol}`}>{folder.repStatus}</span>
                                     <span className="text-slate-400 text-sm font-black w-4 text-center">{expandedFolders[folder.contract] ? 'â–²' : 'â–¼'}</span>
                                 </div>
                             </div>
                             <div className={`p-4 bg-slate-50 border-t border-slate-200 space-y-2 ${expandedFolders[folder.contract] ? 'block' : 'hidden'}`}>
                                     {folder.items.map(item => (
                                         <div key={item.uid} onClick={()=>setModal({isOpen:true, data:item})} className="flex justify-between items-center p-3 bg-white border border-slate-200 rounded-xl hover:border-blue-400 hover:shadow-md cursor-pointer transition">
                                             <div>
                                                <span className="font-black text-slate-800 text-[15px]">{item.ê³ ì¸ëª…}</span> 
                                                <span className="text-xs text-blue-600 font-bold ml-2 bg-blue-50 px-2 py-0.5 rounded">{item.ìƒì„¸ì¢Œí‘œ}</span>
                                                <div className="text-[10px] text-slate-500 mt-1">ì•ˆì¹˜ì˜ˆì •: {item.ì•ˆì¹˜_ì˜ˆì •_ì¼ || 'ë¯¸ì •'} | ê·œê²©: {item.ê·œê²©||'ë¯¸ì •'}</div>
                                             </div>
                                             <span className={`text-xs font-black px-2.5 py-1 rounded ${statusCols[item.ìƒíƒœ]||'bg-slate-100'}`}>{item.ìƒíƒœ}</span>
                                         </div>
                                     ))}
                             </div>
                         </div>
                     )})}
                 </div>
             )}

             {viewMode === 'calendar' && (
                <div className="w-full flex flex-col border border-slate-200 rounded-xl shadow-sm bg-slate-200 gap-px">
                  <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white">
                      <div className="flex items-center space-x-4">
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="px-3 py-1 bg-white border border-slate-200 rounded-lg font-bold">â—€</button>
                        <h2 className="text-xl font-black text-slate-800">{currentDate.getFullYear()}ë…„ {currentDate.getMonth()+1}ì›”</h2>
                        <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="px-3 py-1 bg-white border border-slate-200 rounded-lg font-bold">â–¶</button>
                      </div>
                  </div>
                  <div className="grid grid-cols-7 gap-px">{['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].map((d,i)=>(<div key={d} className={`py-2 text-center text-sm font-black bg-white ${i===6?'text-red-500':i===5?'text-blue-500':'text-slate-700'}`}>{d}</div>))}</div>
                  <div className="grid grid-cols-7 gap-px">
                    {calendarDays.map((d,i)=>(
                      <div key={i} className={`calendar-cell flex flex-col ${!d?'bg-slate-50 cursor-default':''}`}>
                        {d && (
                          <>
                            <div className={`text-right text-xs font-bold p-1 ${getTodayStr() === d.dateStr ? 'text-white bg-blue-600 inline-block self-end rounded-md px-2' : 'text-slate-500'}`}>{d.day}</div>
                            <div className="space-y-1 pb-1">
                              {d.dayEvents.map((ev,idx)=>{
                                const statusCols = { 'ì ‘ìˆ˜':'bg-red-100 text-red-700', 'ë””ìì¸ì™„ë£Œ':'bg-amber-100 text-amber-700', 'ê°ì¸ì™„ë£Œ':'bg-blue-100 text-blue-700', 'ì„¤ì¹˜ì™„ë£Œ':'bg-slate-200 text-slate-500' };
                                const st = statusCols[ev.ìƒíƒœ] || 'bg-slate-100';
                                return <div key={idx} onClick={()=>setModal({isOpen:true, data:ev})} className={`px-1.5 py-0.5 rounded text-[10px] font-bold truncate shadow-sm cursor-pointer ${st}`}>{ev.ê³ ì¸ëª…} ({ev.ìƒíƒœ})</div>
                              })}
                            </div>
                          </>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
             )}

             <Modal isOpen={modal.isOpen} onClose={()=>setModal({isOpen:false, data:null})} title={modal.data ? "ê³ ì¸ ê°ì¸ì •ë³´ ìˆ˜ì •" : "ìƒˆ ê³ ì¸ ê°ì¸ ì¶”ê°€"} isNested={true}>
                 {!modal.data && (
                     <div className="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-100">
                        <label className="form-label text-blue-800">ğŸ¤– AI í…ìŠ¤íŠ¸ ìë™ ë¶„ë¥˜ê¸°</label>
                        <textarea id="ai_text_input" className="form-input min-h-[80px] text-xs" placeholder="[ê³„ì•½ë²ˆí˜¸] 26-001 [ê³ ì¸ëª…] í™ê¸¸ë™ [ì•ˆì¹˜ìœ„ì¹˜] A6/ê°€ 1-1 ... í˜•íƒœì˜ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
                        <button type="button" onClick={handleAiParse} className="w-full mt-2 py-2 bg-blue-600 text-white font-bold rounded-lg text-xs hover:bg-blue-700 transition">í…ìŠ¤íŠ¸ íŒŒì‹± ì ìš©</button>
                     </div>
                 )}
                 <form onSubmit={saveEngraving} className="space-y-4">
                     <div className="grid grid-cols-2 gap-3">
                         <div className="input-group"><label className="form-label text-red-600">ì•ˆì¹˜ ì˜ˆì •ì¼</label><input name="e_an_date" type="date" className="form-input bg-red-50 border-red-200" defaultValue={normalizeDate(modal.data?.ì•ˆì¹˜_ì˜ˆì •_ì¼)} /></div>
                         <div className="input-group"><label className="form-label text-blue-600">ì§„í–‰ìƒíƒœ</label><select name="e_status" className="form-input border-blue-200" defaultValue={modal.data?.ìƒíƒœ || 'ì ‘ìˆ˜'}><option>ì ‘ìˆ˜</option><option>ë””ìì¸ì™„ë£Œ</option><option>ê°ì¸ì™„ë£Œ</option><option>ì„¤ì¹˜ì™„ë£Œ</option></select></div>
                     </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div className="input-group"><label className="form-label">ê³ ì¸ëª…</label><input name="e_name" type="text" className="form-input text-lg" defaultValue={modal.data?.ê³ ì¸ëª…} required /></div>
                         <div className="input-group"><label className="form-label">ê³„ì•½ë²ˆí˜¸ (í´ë”ë§ í‚¤)</label><input name="e_contractNo" type="text" className="form-input border-blue-300 bg-blue-50" defaultValue={modal.data?.ê³„ì•½ë²ˆí˜¸} required /></div>
                     </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div className="input-group">
                             <label className="form-label">ìƒë…„ì›”ì¼ / ìŒì–‘</label>
                             <div className="flex gap-1"><input name="e_birth" type="date" className="form-input w-2/3" defaultValue={normalizeDate(modal.data?.ìƒë…„ì›”ì¼)} /><select name="e_birth_type" className="form-input w-1/3 px-1" defaultValue={modal.data?.ìƒ_ìŒì–‘||'ì–‘'}><option>ì–‘</option><option>ìŒ</option></select></div>
                         </div>
                         <div className="input-group">
                             <label className="form-label">ì¡¸ë…„ì›”ì¼ / ìŒì–‘</label>
                             <div className="flex gap-1"><input name="e_death" type="date" className="form-input w-2/3" defaultValue={normalizeDate(modal.data?.ì¡¸ë…„ì›”ì¼)} /><select name="e_death_type" className="form-input w-1/3 px-1" defaultValue={modal.data?.ì¡¸_ìŒì–‘||'ì–‘'}><option>ì–‘</option><option>ìŒ</option></select></div>
                         </div>
                     </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div className="input-group"><label className="form-label">ì•ˆì¹˜ìœ„ì¹˜</label><input name="e_loc" type="text" className="form-input" defaultValue={modal.data?.ìƒì„¸ì¢Œí‘œ} /></div>
                         <div className="input-group"><label className="form-label">ê´‘ì¤‘ìœ„ì¹˜</label><input name="e_gwang" type="text" className="form-input" defaultValue={modal.data?.ê´‘ì¤‘ìœ„ì¹˜} placeholder="ì¢Œ/ìš°/í•©ì¥" /></div>
                     </div>
                     <div className="grid grid-cols-3 gap-3">
                         <div className="input-group"><label className="form-label">ê·œê²©(ì„ì¬)</label><select name="e_stone" className="form-input" defaultValue={modal.data?.ê·œê²©||'100*70'}><option value="100*70">100*70 (ì˜¤ì„)</option><option value="160*100">160*100 (í‘œì°°)</option><option value="130*80">130*80 (í‘œì°°)</option><option value="100*62">100*62 (í‘œì°°)</option></select></div>
                         <div className="input-group"><label className="form-label">ì¢…êµ</label><select name="e_rel" className="form-input" defaultValue={modal.data?.ì¢…êµ||'ê¸°ë…êµ'}><option>ê¸°ë…êµ</option><option>ì²œì£¼êµ</option><option>ë¶ˆêµ</option><option>ë¬´êµ/ê¸°íƒ€</option></select></div>
                         <div className="input-group"><label className="form-label">í‘œê¸°(í•œìë“±)</label><input name="e_mark" type="text" className="form-input" defaultValue={modal.data?.í‘œê¸°} /></div>
                     </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div className="input-group"><label className="form-label">ì‹ ì²­ì„œ í™•ì¸</label><select name="e_form" className="form-input" defaultValue={modal.data?.ì‹ ì²­ì„œ||'ë¯¸í™•ì¸'}><option>ë¯¸í™•ì¸</option><option>í™•ì¸ì™„ë£Œ</option></select></div>
                         <div className="input-group"><label className="form-label">ê°ì¸ í™•ì¸</label><select name="e_print" className="form-input" defaultValue={modal.data?.ê°ì¸||'ë¯¸í™•ì¸'}><option>ë¯¸í™•ì¸</option><option>í™•ì¸ì™„ë£Œ</option></select></div>
                     </div>
                     <div className="input-group"><label className="form-label">ê³„ì•½ì</label><input name="e_contractor" type="text" className="form-input" defaultValue={modal.data?.ê³„ì•½ì} /></div>
                     <div className="input-group"><label className="form-label">ê¸°íƒ€ ë¹„ê³  ë©”ëª¨</label><textarea name="e_memo" className="form-input min-h-[60px]" defaultValue={clean(modal.data?.ë¹„ê³ )}></textarea></div>
                     
                     <div className="flex gap-2 pt-2">
                         {modal.data && <button type="button" onClick={() => deleteEngraving(modal.data.uid)} className="flex-1 py-3 bg-red-50 text-red-600 font-bold rounded-xl text-sm hover:bg-red-100 transition">ì‚­ì œ</button>}
                         <button type="submit" className="flex-[2] py-3 bg-stone-800 text-white font-black rounded-xl text-sm shadow-lg">DB ì €ì¥</button>
                     </div>
                 </form>
             </Modal>
          </div>
       )
    }

    function ContactsWorkspace() {
       const [contacts, setContacts] = useState([]);
       const [modal, setModal] = useState({ isOpen: false, data: null });
       const [tags, setTags] = useState([]);
       const [tagInput, setTagInput] = useState('');
       const [allExistingTags, setAllExistingTags] = useState([]);
       const [contactSearch, setContactSearch] = useState('');

       const fetchContacts = async () => {
           try {
               const res = await supabaseClient.from('contacts').select('*').order('company_name', {ascending: true});
               if(res.data) {
                   setContacts(res.data);
                   const tagSet = new Set();
                   res.data.forEach(c => { if(c.job_type) c.job_type.split(',').forEach(t => tagSet.add(t.trim())); });
                   tagSet.delete(''); setAllExistingTags(Array.from(tagSet));
               }
           } catch(e) {}
       };
       useEffect(() => { fetchContacts(); }, []);

       const filteredContacts = useMemo(() => {
           if(!contactSearch.trim()) return contacts;
           const q = contactSearch.toLowerCase();
           const qPhone = q.replace(/[^0-9]/g, '');
           
           return contacts.filter(c => {
               const matchText = String(c.company_name||'').toLowerCase().includes(q) || String(c.manager_name||'').toLowerCase().includes(q) || String(c.job_type||'').toLowerCase().includes(q) || String(c.memo||'').toLowerCase().includes(q);
               const matchPhone = qPhone ? String(c.phone1||'').replace(/[^0-9]/g,'').includes(qPhone) : false;
               return matchText || matchPhone;
           });
       }, [contacts, contactSearch]);

       const openModal = (data) => {
           setModal({isOpen: true, data});
           if(data?.job_type) setTags(data.job_type.split(',').map(t=>t.trim()).filter(Boolean)); else setTags([]);
           setTagInput('');
       };

       const handleTagKey = (e) => {
           if(e.key === 'Enter') {
               e.preventDefault(); const val = tagInput.trim();
               if(val && !tags.includes(val)) setTags([...tags, val]); setTagInput('');
           }
       };
       const addTagFromSuggest = (t) => { if(!tags.includes(t)) setTags([...tags, t]); };

       const saveContact = async (e) => {
           e.preventDefault();
           const payload = { company_name: nullIfEmpty(e.target.c_comp.value), manager_name: nullIfEmpty(e.target.c_name.value), phone1: nullIfEmpty(e.target.c_phone.value), phone2: nullIfEmpty(e.target.c_phone2.value), job_type: tags.join(','), email: nullIfEmpty(e.target.c_email.value), url: nullIfEmpty(e.target.c_url.value), memo: nullIfEmpty(e.target.c_memo.value) };
           let err;
           if(modal.data?.id) { const res = await supabaseClient.from('contacts').update(payload).eq('id', modal.data.id); err = res.error; } 
           else { const res = await supabaseClient.from('contacts').insert(payload); err = res.error; }
           if(err) { alert("ì €ì¥ ì‹¤íŒ¨: " + err.message); return; }
           setModal({isOpen:false, data:null}); fetchContacts();
       };

       return (
          <div className="bg-white p-4 sm:p-8 rounded-2xl shadow border border-slate-200 min-h-[50vh] w-full mt-4 mb-10 relative">
             <div className="flex justify-between items-center mb-4 border-b pb-4">
                <h2 className="text-xl sm:text-2xl font-black text-slate-800">ğŸ“ í†µí•© ì£¼ì†Œë¡</h2>
                <button onClick={() => openModal(null)} className="px-4 py-2 bg-emerald-600 text-white font-bold rounded-lg shadow text-sm hover:bg-emerald-700 transition">+ ì—°ë½ì²˜ ì¶”ê°€</button>
             </div>
             
             <div className="mb-6 relative z-10">
                 <input type="text" placeholder="ğŸ” ì—…ì²´ëª…, ë‹´ë‹¹ì, ë²ˆí˜¸, íƒœê·¸ ê²€ìƒ‰..." value={contactSearch} onChange={e=>setContactSearch(e.target.value)} className="w-full p-3 rounded-xl border border-emerald-200 shadow-sm text-sm font-bold focus:border-emerald-500 focus:outline-none" />
             </div>

             <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                 {filteredContacts.length === 0 ? <p className="col-span-2 text-center text-slate-400 py-10 font-bold">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p> : filteredContacts.map(c => (
                     <div key={c.id} onClick={()=>openModal(c)} className="p-4 border border-emerald-100 bg-emerald-50/30 rounded-xl flex justify-between items-center cursor-pointer hover:bg-emerald-50 transition shadow-sm relative">
                         <div className="w-full pr-14">
                             <div className="flex gap-1 mb-1.5 flex-wrap">
                               {c.job_type ? c.job_type.split(',').map((t,i) => <span key={i} className="text-[9px] bg-emerald-100 text-emerald-700 border border-emerald-200 px-2 py-0.5 rounded-full font-black">{t}</span>) : <span className="text-[9px] text-slate-400">íƒœê·¸ ì—†ìŒ</span>}
                             </div>
                             <div className="font-black text-slate-800 text-lg mt-0.5">{c.company_name} <span className="text-sm font-medium text-slate-500 ml-1">{c.manager_name}</span></div>
                             <div className="text-xs font-bold text-slate-600 mt-1">ğŸ“ {c.phone1} {c.phone2 && ` / ${c.phone2}`}</div>
                             {c.url && <div className="text-xs mt-1 truncate">{renderWithLinks(c.url)}</div>}
                         </div>
                         <a href={`tel:${c.phone1}`} onClick={(e)=>e.stopPropagation()} className="absolute right-4 top-1/2 -translate-y-1/2 bg-white border border-emerald-200 text-emerald-600 p-3 rounded-full hover:bg-emerald-100 transition shadow-sm">ğŸ“</a>
                     </div>
                 ))}
             </div>

             <Modal isOpen={modal.isOpen} onClose={()=>setModal({isOpen:false, data:null})} title={modal.data ? "ì—°ë½ì²˜ ìˆ˜ì •" : "ìƒˆ ì—°ë½ì²˜ ì¶”ê°€"} isNested={true}>
                 <form onSubmit={saveContact} className="space-y-4">
                     <div className="input-group">
                         <label className="form-label text-emerald-600">ì—­í•  íƒœê·¸ (ì—”í„°ë¡œ ì¶”ê°€)</label>
                         <div className="flex flex-wrap gap-2 mb-2 p-2 border rounded-lg min-h-[42px] bg-slate-50 focus-within:border-emerald-500 focus-within:bg-white transition">
                             {tags.map(t => (
                                 <span key={t} className="bg-emerald-200 text-emerald-800 border border-emerald-300 px-2 py-1 rounded-full text-xs font-black flex items-center gap-1 shadow-sm">
                                    {t} <span onClick={()=>setTags(tags.filter(x=>x!==t))} className="cursor-pointer text-emerald-600 hover:text-red-500 ml-1">âœ•</span>
                                 </span>
                             ))}
                             <input type="text" value={tagInput} onChange={e=>setTagInput(e.target.value)} onKeyDown={handleTagKey} className="bg-transparent outline-none text-sm font-bold w-24 flex-1" placeholder="ì¡°ê²½, ëª©ìˆ˜ ë“±..." />
                         </div>
                         {allExistingTags.length > 0 && (
                             <div className="flex flex-wrap gap-1 mt-1">
                                 <span className="text-[10px] text-slate-400 mr-1 mt-0.5 font-bold">ì¶”ì²œ:</span>
                                 {allExistingTags.map(t => (
                                     <button key={t} type="button" onClick={()=>addTagFromSuggest(t)} className="text-[10px] bg-slate-100 border border-slate-200 text-slate-600 px-2 py-0.5 rounded-full hover:bg-slate-200">{t}</button>
                                 ))}
                             </div>
                         )}
                     </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div className="input-group"><label className="form-label">ì—…ì²´ëª…</label><input name="c_comp" type="text" className="form-input text-lg" defaultValue={modal.data?.company_name} required /></div>
                         <div className="input-group"><label className="form-label">ë‹´ë‹¹ìëª…</label><input name="c_name" type="text" className="form-input" defaultValue={modal.data?.manager_name} /></div>
                     </div>
                     <div className="grid grid-cols-2 gap-3">
                         <div className="input-group"><label className="form-label">ì—°ë½ì²˜ 1</label><input name="c_phone" type="text" className="form-input" defaultValue={modal.data?.phone1} required /></div>
                         <div className="input-group"><label className="form-label">ì—°ë½ì²˜ 2</label><input name="c_phone2" type="text" className="form-input" defaultValue={modal.data?.phone2} /></div>
                     </div>
                     <div className="input-group"><label className="form-label">ì´ë©”ì¼</label><input name="c_email" type="email" className="form-input" defaultValue={modal.data?.email} /></div>
                     <div className="input-group"><label className="form-label">ì›¹ì‚¬ì´íŠ¸ (URL)</label><input name="c_url" type="text" className="form-input" defaultValue={modal.data?.url} placeholder="https://..." /></div>
                     <div className="input-group"><label className="form-label">ë¹„ê³  ë©”ëª¨</label><textarea name="c_memo" className="form-input min-h-[60px]" defaultValue={modal.data?.memo}></textarea></div>
                     
                     <div className="flex gap-2 pt-2">
                         <button type="submit" className="w-full py-3 bg-emerald-600 text-white font-black rounded-xl text-sm hover:bg-emerald-700 shadow-lg">DB ì €ì¥</button>
                     </div>
                 </form>
             </Modal>
          </div>
       )
    }

    function App() {
      const [activeTab, setActiveTab] = useState('dash');
      const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 1024);
      const [layoutData, setLayoutData] = useState({});

      useEffect(() => {
        const handleResize = () => { if (window.innerWidth > 1024) setIsSidebarOpen(true); else setIsSidebarOpen(false); };
        window.addEventListener('resize', handleResize); return () => window.removeEventListener('resize', handleResize);
      }, []);
      useEffect(() => { fetch('/map_layout.json').then(res => res.json()).then(json => setLayoutData(json)).catch(err => console.error(err)); }, []);

      return (
        <div className="flex h-screen overflow-hidden bg-slate-900">
          {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-40 lg:hidden backdrop-blur-sm transition-opacity" onClick={() => setIsSidebarOpen(false)} />}
          
          <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 border-r border-slate-800 text-slate-300 transform transition-transform duration-300 ease-in-out lg:static lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:hidden'} flex flex-col shadow-2xl lg:shadow-none`}>
            <div className="p-6 border-b border-slate-800 flex justify-between items-center shrink-0">
              <h1 className="text-xl font-black text-white tracking-tighter">JAKE WorkOS <span className="text-[10px] bg-emerald-500 px-1.5 py-0.5 rounded ml-1 text-slate-900">V48</span></h1>
              <button className="lg:hidden text-slate-400 hover:text-white transition font-bold" onClick={() => setIsSidebarOpen(false)}>âœ•</button>
            </div>
            <nav className="p-4 space-y-8 overflow-y-auto flex-1 custom-scrollbar">
              <div>
                <p className="text-[10px] font-black text-slate-500 mb-3 ml-2 uppercase tracking-widest">Team Workspace</p>
                <div className="space-y-1">
                  <button onClick={() => {setActiveTab('dash'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'dash' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800'}`}>ğŸ“… í†µí•© ì¼ì • ê´€ë¦¬</button>
                  <button onClick={() => {setActiveTab('field'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'field' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800'}`}>ğŸ“ í˜„ì¥ ì§€ë„ (Map)</button>
                  <button onClick={() => {setActiveTab('hr'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'hr' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800'}`}>ğŸ–ï¸ ê·¼íƒœ ê´€ë¦¬</button>
                  <button onClick={() => {setActiveTab('stats'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'stats' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800'}`}>ğŸ“ˆ í†µê³„/ë¶„ì„</button>
                </div>
              </div>
              
              <div>
                <p className="text-[10px] font-black text-indigo-400 mb-3 ml-2 uppercase tracking-widest">Jake Personal</p>
                <div className="space-y-1">
                  <button onClick={() => {setActiveTab('projects'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'projects' ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>ğŸš€ í”„ë¡œì íŠ¸ ê´€ë¦¬</button>
                  <button onClick={() => {setActiveTab('minutes'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'minutes' ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>ğŸ“ íšŒì˜ë¡</button>
                  <button onClick={() => {setActiveTab('engraving'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'engraving' ? 'bg-stone-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>âš°ï¸ ê°ì¸ ê´€ë¦¬</button>
                  <button onClick={() => {setActiveTab('contacts'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'contacts' ? 'bg-emerald-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>ğŸ“ ì—°ë½ì²˜ (ì£¼ì†Œë¡)</button>
                </div>
              </div>
            </nav>
          </aside>

          <main className="flex-1 flex flex-col h-screen overflow-y-auto overflow-x-hidden bg-[#F8FAFC]">
            <header className="h-14 bg-white border-b border-slate-200 flex items-center px-4 justify-between shrink-0 sticky top-0 z-[90] shadow-sm">
              <div className="flex items-center">
                <button className="p-2 text-slate-500 hover:bg-slate-100 transition rounded-lg mr-3" onClick={() => setIsSidebarOpen(!isSidebarOpen)}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h2 className="font-black text-lg text-slate-800 tracking-tight">
                  {activeTab === 'dash' ? 'Integrated Dashboard' : activeTab === 'field' ? 'Field Control Map' : activeTab === 'hr' ? 'HR Management' : activeTab === 'stats' ? 'Statistics Analytics' : activeTab === 'projects' ? 'Project Kanban' : activeTab === 'minutes' ? 'Meeting Minutes' : activeTab === 'engraving' ? 'Engraving Ops' : 'Contacts'}
                </h2>
              </div>
            </header>
            
            <div className="w-full p-2 md:p-4 pb-20">
              {activeTab === 'dash' && <DashboardView layoutData={layoutData} />}
              {activeTab === 'field' && <FieldView layoutData={layoutData} />}
              {activeTab === 'hr' && <HrView />}
              {activeTab === 'stats' && <StatsView />}
              {activeTab === 'projects' && <ProjectsWorkspace />}
              {activeTab === 'minutes' && <MinutesWorkspace />}
              {activeTab === 'engraving' && <EngravingWorkspace />}
              {activeTab === 'contacts' && <ContactsWorkspace />}
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render( <ErrorBoundary><App /></ErrorBoundary> );
  </script>
</body>
</html>
