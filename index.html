<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Jake WorkOS V9 - Real Map & Modal</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
    body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; color: #1e293b; -webkit-font-smoothing: antialiased; overflow: hidden; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* í˜„ì‹¤ ì§€ë„ ì „ìš© ìŠ¤íƒ€ì¼ */
    .row-container { display: flex; flex-direction: row; gap: 4px; margin-bottom: 8px; width: max-content; }
    .slot { width: 80px; min-width: 80px; height: 65px; border-radius: 6px; font-size: 11px; font-weight: 700; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .slot:active { transform: scale(0.95); opacity: 0.8; }
    
    /* ëª¨ë‹¬ ì• ë‹ˆë©”ì´ì…˜ */
    .modal-enter { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ğŸ” Supabase Configuration
    const SUPABASE_URL = 'https://lqccxnciiajwqdmpwjdv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxY2N4bmNpaWFqd3FkbXB3amR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjA3MTMsImV4cCI6MjA4NzA5NjcxM30.L23-eq-DIPsbONOeX-xQ8UcMb7gtgTTTRpkaSm9HTw4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ğŸ›¡ï¸ Data Helpers
    const clean = (val) => (!val || val === '0.0' || val === '0' || val === 'null' || val === ' -  - ') ? '' : String(val).trim();
    const normalizeDate = (v) => { if(!v) return null; const d = new Date(String(v).replace(/\./g,'-').replace(/\s/g,'')); return isNaN(d.getTime()) ? null : d.toISOString().split('T')[0]; };

    // ğŸ“ í˜„ì‹¤ ì§€ë„ ë ˆì´ì•„ì›ƒ ë°ì´í„° (Jakeì˜ GAS ì†ŒìŠ¤ ë³µì œ)
    const SECTION_LIST = ['A2/ê°€','A3/ê°€','A4/ê°€','A4/ë‚˜','A4/ë‹¤','A5/ê°€','A5/ë‚˜','A6/ê°€','A6/ë‚˜','B1/ê°€','B2/ê°€','B3/ê°€','B4/ê°€','B5/ê°€','B6/ê°€/1-12','B6/ê°€/13-14','C1/ê°€'];
    const ROW_CONFIG = { 
      'A2/ê°€':[12], 'A3/ê°€':[8,8], 'A4/ê°€':[12,12,12,12,18,18,28,12], 'A4/ë‚˜':[9,11,7,8,8], 'A4/ë‹¤':[6,6], 'A5/ê°€':[13,14,14,13,13,15,11], 
      'A5/ë‚˜':[23,22,26,25,30,47,47,30,39], 'A6/ê°€':[27,27,22,18,19,15,13], 'A6/ë‚˜':[25,26,26,26,26,26], 'C1/ê°€':[13,17,21,25], 
      'B1/ê°€':[20,23], 'B2/ê°€':[34,34,35,34,34], 'B3/ê°€':[48,46,45,41], 'B4/ê°€':[37,38,41,41,34], 'B5/ê°€':[47,47,49,48,40,32], 
      'B6/ê°€/1-12':[47,52,53,52,53,53,54,54,54,53,55,54,50], 'B6/ê°€/13-14':[75,75,75,75,75,75,75,75,75] 
    };

    // ==========================================
    // ğŸ§± Component: Global Modal System
    // ==========================================
    function Modal({ isOpen, onClose, title, children }) {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm modal-enter">
          <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[85vh] overflow-hidden flex flex-col">
            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
              <h3 className="text-xl font-black text-slate-800 tracking-tight">{title}</h3>
              <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition text-slate-400">âœ•</button>
            </div>
            <div className="flex-1 overflow-y-auto p-6 no-scrollbar">{children}</div>
            <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-end">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition">ë‹«ê¸°</button>
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // ğŸ“Š View: Dashboard (Unified)
    // ==========================================
    function DashboardView({ onEventClick }) {
      const [loading, setLoading] = useState(true);
      const [events, setEvents] = useState([]);
      const [currentDate, setCurrentDate] = useState(new Date());

      useEffect(() => {
        const fetch = async () => {
          setLoading(true);
          const [burRes, salRes] = await Promise.all([
            supabaseClient.from('burial_schedule').select('*'),
            supabaseClient.from('status_mgmt').select('*')
          ]);
          const combined = [
            ...(burRes.data || []).map(b => ({ type:'burial', date:normalizeDate(b.ì•ˆì¹˜ì¼), title:clean(b.ê³ ì¸ëª…), sub:clean(b.ìœ„ì¹˜), raw:b })),
            ...(salRes.data || []).map(s => ({ type:'sales', date:normalizeDate(s.ë‹µì‚¬ì¼)||normalizeDate(s.ë“±ë¡ì¼), title:clean(s.ê³ ê°_ê³ ì¸_ëª…), sub:`${clean(s.ì˜ì—…ìì„±í•¨)}`, status:s.í˜„ì¬ìƒíƒœ, raw:s }))
          ].filter(e => e.date !== null && e.status !== 'ìƒë‹´ í›„ ëŒ€ê¸°');
          setEvents(combined);
          setLoading(false);
        };
        fetch();
      }, []);

      const calendarDays = useMemo(() => {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const startDay = new Date(year, month, 1).getDay(), offset = startDay === 0 ? 6 : startDay - 1;
        const lastDate = new Date(year, month + 1, 0).getDate();
        const days = [];
        for (let i = 0; i < offset; i++) days.push(null);
        for (let i = 1; i <= lastDate; i++) {
          const ds = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          days.push({ day: i, dateStr: ds, dayEvents: events.filter(e => e.date === ds) });
        }
        return days;
      }, [currentDate, events]);

      return (
        <div className="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
          <div className="p-6 flex justify-between items-center border-b border-slate-100">
            <div className="flex items-center space-x-4">
              <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 hover:bg-slate-100 rounded-full transition">â—€</button>
              <h2 className="text-2xl font-black text-slate-800 tracking-tighter">{currentDate.getFullYear()}ë…„ {currentDate.getMonth() + 1}ì›”</h2>
              <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 hover:bg-slate-100 rounded-full transition">â–¶</button>
            </div>
            <div className="flex gap-2 text-[10px] font-black uppercase tracking-tighter">
              <span className="px-2 py-1 bg-emerald-600 text-white rounded-lg">Burial</span>
              <span className="px-2 py-1 bg-amber-400 text-amber-900 rounded-lg">Sales</span>
            </div>
          </div>
          <div className="grid grid-cols-7 gap-px bg-slate-200">
            {['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].map((d,i)=>(<div key={d} className={`p-3 text-center text-xs font-black bg-slate-50 ${i===6?'text-red-500':i===5?'text-blue-500':'text-slate-400'}`}>{d}</div>))}
            {calendarDays.map((d,i)=>(
              <div key={i} className={`min-h-[120px] bg-white p-1.5 ${!d?'bg-slate-50/50':''}`}>
                {d && (
                  <>
                    <div className="text-right text-[10px] font-bold text-slate-300 mb-1">{d.day}</div>
                    <div className="space-y-1">
                      {d.dayEvents.map((ev,idx)=>(
                        <div key={idx} onClick={()=>onEventClick(ev)} className={`px-1.5 py-1 rounded text-[10px] font-bold truncate cursor-pointer shadow-sm border ${ev.type==='burial'?'bg-emerald-600 text-white border-emerald-700':'bg-amber-400 text-amber-900 border-amber-500'}`}>
                          {ev.title}
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ==========================================
    // ğŸ” View: Field Map (Real-Layout Engine)
    // ==========================================
    function FieldView({ onSlotClick }) {
      const [loading, setLoading] = useState(true);
      const [slots, setSlots] = useState([]);
      const [currentArea, setCurrentArea] = useState('A6/ê°€');

      useEffect(() => {
        const fetch = async () => {
          setLoading(true);
          const { data } = await supabaseClient.from('field_data').select('*').eq('êµ¬ì—­', currentArea).order('ìœ„ì¹˜_ë²ˆí˜¸', { ascending: true });
          setSlots(data || []);
          setLoading(false);
        };
        fetch();
      }, [currentArea]);

      // ğŸ—ºï¸ ìŠ¬ë¡¯ì„ í–‰ë³„ë¡œ ìª¼ê°œëŠ” ì—”ì§„
      const renderedRows = useMemo(() => {
        const rows = [];
        let currentIndex = 0;
        const config = ROW_CONFIG[currentArea] || [20];
        
        config.forEach(count => {
          const rowData = slots.slice(currentIndex, currentIndex + count);
          rows.push(rowData);
          currentIndex += count;
        });
        return rows;
      }, [slots, currentArea]);

      return (
        <div className="space-y-6">
          <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar shrink-0">
            {SECTION_LIST.map(s => (
              <button key={s} onClick={() => setCurrentArea(s)} className={`px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-all border shadow-sm ${currentArea === s ? 'bg-slate-800 text-white border-slate-800 scale-105' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-400'}`}>{s}</button>
            ))}
          </div>

          <div className="bg-white p-6 rounded-3xl shadow-xl border border-slate-200 min-h-[500px] overflow-x-auto no-scrollbar">
            {loading ? <div className="p-40 text-center font-black text-slate-300 animate-pulse uppercase tracking-widest">Map Synchronizing...</div> : (
              <div className="w-max mx-auto">
                {renderedRows.map((row, rIdx) => (
                  <div key={rIdx} className="row-container">
                    {row.map((s, sIdx) => {
                      const status = clean(s.ê³„ì•½_ìƒíƒœ) || 'ë¯¸ë¶„ì–‘';
                      const colors = {
                        'ì•ˆì¹˜': 'bg-emerald-600 text-white border-emerald-700',
                        'ì˜ˆì•½': 'bg-amber-400 text-amber-900 border-amber-500',
                        'ê³„ì•½ê¸ˆ': 'bg-amber-100 text-amber-700 border-amber-200',
                        'í™€ë”©': 'bg-rose-600 text-white border-rose-700',
                        'ë¯¸ë¶„ì–‘': 'bg-slate-50 text-slate-300 border-slate-200'
                      };
                      return (
                        <div key={sIdx} onClick={()=>onSlotClick(s)} className={`slot ${colors[status] || colors['ë¯¸ë¶„ì–‘']}`}>
                          <div className="text-[9px] opacity-70 mb-0.5">{s.ìœ„ì¹˜_ë²ˆí˜¸}</div>
                          <div className="text-[11px] font-black truncate w-[70px] text-center">{clean(s.ì„±í•¨) || clean(s.ê³„ì•½ì) || status}</div>
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==========================================
    // âš™ï¸ Main Application Controller
    // ==========================================
    function App() {
      const [activeTab, setActiveTab] = useState('dash');
      const [isSidebarOpen, setIsSidebarOpen] = useState(false);
      const [modal, setModal] = useState({ isOpen: false, title: '', content: null });

      const openModal = (title, content) => setModal({ isOpen: true, title, content });
      const closeModal = () => setModal({ ...modal, isOpen: false });

      // íŒì—… ë Œë”ë§ ë¡œì§
      const handleEventClick = (ev) => {
        const content = (
          <div className="space-y-4 font-bold">
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase mb-1">ë‚ ì§œ</p>
                <p className="text-slate-800">{ev.date}</p>
              </div>
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase mb-1">êµ¬ë¶„</p>
                <p className={ev.type==='burial'?'text-emerald-600':'text-amber-600'}>{ev.type==='burial'?'ì•ˆì¹˜ ì¼ì •':'ì˜ì—…/ë‹µì‚¬'}</p>
              </div>
            </div>
            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
              <p className="text-[10px] text-slate-400 uppercase mb-1">ìƒì„¸ ë‚´ìš©</p>
              <p className="text-lg text-slate-800">{ev.title}</p>
              <p className="text-sm text-slate-500 mt-2">{ev.sub}</p>
            </div>
            {ev.raw.ë¹„ê³  && (
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase mb-1">ë¹„ê³ </p>
                <p className="text-sm text-slate-600 whitespace-pre-wrap">{clean(ev.raw.ë¹„ê³ )}</p>
              </div>
            )}
          </div>
        );
        openModal(ev.type === 'burial' ? 'ì•ˆì¹˜ ìƒì„¸ ì •ë³´' : 'ì˜ì—…/ë‹µì‚¬ ìƒì„¸ ì •ë³´', content);
      };

      const handleSlotClick = (s) => {
        const content = (
          <div className="space-y-4 font-bold">
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase mb-1">ìœ„ì¹˜ ë²ˆí˜¸</p>
                <p className="text-slate-800 text-lg">{s.êµ¬ì—­} {s.ìœ„ì¹˜_ë²ˆí˜¸}</p>
              </div>
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase mb-1">ìƒíƒœ</p>
                <p className="text-blue-600">{clean(s.ê³„ì•½_ìƒíƒœ)}</p>
              </div>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase mb-1">ì„±í•¨(ì•ˆì¹˜ì)</p>
                <p className="text-slate-800">{clean(s.ì„±í•¨) || '-'}</p>
              </div>
              <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <p className="text-[10px] text-slate-400 uppercase mb-1">ê³„ì•½ì</p>
                <p className="text-slate-800">{clean(s.ê³„ì•½ì) || '-'}</p>
              </div>
            </div>
            <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
              <p className="text-[10px] text-slate-400 uppercase mb-1">ë©”ëª¨</p>
              <p className="text-sm text-slate-600">{clean(s.ë©”ëª¨) || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}</p>
            </div>
          </div>
        );
        openModal('í˜„ì¥ ìŠ¬ë¡¯ ìƒì„¸ ì •ë³´', content);
      };

      // Sidebar items same as V8
      return (
        <div className="flex h-screen overflow-hidden">
          {/* Sidebar logic remains identical to V8 but UI is ported to V9 standard */}
          <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 transform transition-transform duration-300 lg:translate-x-0 lg:static ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="p-6 border-b border-slate-800 flex justify-between items-center">
              <h1 className="text-xl font-black text-white tracking-tighter">JAKE WorkOS <span className="text-xs bg-blue-600 px-1.5 py-0.5 rounded ml-1 font-bold">V9</span></h1>
              <button className="lg:hidden text-slate-400" onClick={() => setIsSidebarOpen(false)}>âœ•</button>
            </div>
            <nav className="p-4 space-y-6 overflow-y-auto h-[calc(100vh-80px)] no-scrollbar">
              <div>
                <p className="text-[10px] font-black text-slate-500 mb-3 ml-2 uppercase tracking-widest">TEAM APPS</p>
                <div className="space-y-1">
                  <button onClick={() => {setActiveTab('dash'); setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-2xl font-bold text-sm transition-all ${activeTab === 'dash' ? 'bg-blue-600 text-white shadow-xl shadow-blue-900/30' : 'hover:bg-slate-800'}`}>ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ</button>
                  <button onClick={() => {setActiveTab('field'); setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-2xl font-bold text-sm transition-all ${activeTab === 'field' ? 'bg-blue-600 text-white shadow-xl shadow-blue-900/30' : 'hover:bg-slate-800'}`}>ğŸ” í˜„ì¥ê´€ë¦¬ (Grid)</button>
                </div>
              </div>
              <div>
                <p className="text-[10px] font-black text-slate-500 mb-3 ml-2 uppercase tracking-widest">WORK OS</p>
                <div className="space-y-1">
                  <button className="w-full flex items-center px-4 py-3 rounded-2xl font-bold text-sm text-slate-600 cursor-not-allowed italic">ğŸš§ Porting Modules...</button>
                </div>
              </div>
            </nav>
          </aside>
          
          <main className="flex-1 flex flex-col h-screen overflow-hidden">
            <header className="h-16 bg-white border-b border-slate-200 flex items-center px-6 shrink-0 justify-between z-30 shadow-sm">
              <div className="flex items-center">
                <button className="lg:hidden p-2 text-slate-500 bg-slate-100 rounded-lg mr-4" onClick={() => setIsSidebarOpen(true)}>â˜°</button>
                <h2 className="font-black text-xl text-slate-800 uppercase tracking-tighter">{activeTab}</h2>
              </div>
              <div className="flex items-center space-x-2">
                <span className="text-[10px] font-black text-slate-400 tracking-widest uppercase">Zephyrus G14 System Online</span>
                <div className="h-2 w-2 rounded-full bg-blue-500 animate-pulse" />
              </div>
            </header>

            <div className="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar bg-[#F8FAFC]">
              {activeTab === 'dash' && <DashboardView onEventClick={handleEventClick} />}
              {activeTab === 'field' && <FieldView onSlotClick={handleSlotClick} />}
            </div>
          </main>

          <Modal isOpen={modal.isOpen} onClose={closeModal} title={modal.title}>{modal.content}</Modal>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
