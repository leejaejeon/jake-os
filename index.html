<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Jake WorkOS V8 - Bulletproof</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
    body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; color: #1e293b; -webkit-font-smoothing: antialiased; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; }
    .calendar-cell { min-height: 120px; background-color: #fff; padding: 4px; transition: background 0.2s; }
    .calendar-cell:hover { background-color: #f8fafc; }
    @media (max-width: 640px) { .calendar-cell { min-height: 80px; font-size: 10px; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;

    // ğŸ” Supabase Configuration
    const SUPABASE_URL = 'https://lqccxnciiajwqdmpwjdv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxY2N4bmNpaWFqd3FkbXB3amR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjA3MTMsImV4cCI6MjA4NzA5NjcxM30.L23-eq-DIPsbONOeX-xQ8UcMb7gtgTTTRpkaSm9HTw4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ğŸ›¡ï¸ Data Sanitizer (First Principles)
    const clean = (val) => {
      if (!val || val === '0.0' || val === '0' || val === 'null' || val === ' -  - ') return '';
      return String(val).trim();
    };

    const normalizeDate = (dateVal) => {
      if (!dateVal) return null;
      const d = new Date(String(dateVal).replace(/\./g, '-').replace(/\s/g, ''));
      return isNaN(d.getTime()) ? null : d.toISOString().split('T')[0];
    };

    // ==========================================
    // ğŸ§© UI Component: Navigation Sidebar
    // ==========================================
    function Sidebar({ activeTab, setActiveTab, isOpen, setIsOpen }) {
      const menus = [
        { group: 'ê³µìœ ì•± (TEAM)', items: [
          { id: 'dash', icon: 'ğŸ“Š', label: 'í†µí•© ëŒ€ì‹œë³´ë“œ' },
          { id: 'field', icon: 'ğŸ”', label: 'í˜„ì¥ê´€ë¦¬ (Grid)' },
          { id: 'hr', icon: 'ğŸ–ï¸', label: 'ê·¼íƒœê´€ë¦¬' }
        ]},
        { group: 'WorkOS (JAKE)', items: [
          { id: 'project', icon: 'ğŸš€', label: 'í”„ë¡œì íŠ¸ ì¹¸ë°˜' },
          { id: 'engraving', icon: 'âš°ï¸', label: 'ê°ì¸ê´€ë¦¬' },
          { id: 'meeting', icon: 'ğŸ“', label: 'íšŒì˜ë¡/í˜„ì•ˆ' },
          { id: 'contact', icon: 'ğŸ“‡', label: 'ì—°ë½ì²˜' }
        ]}
      ];

      return (
        <>
          {isOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden" onClick={() => setIsOpen(false)} />}
          <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 transform transition-transform duration-300 lg:translate-x-0 lg:static ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="p-6 border-b border-slate-800 flex justify-between items-center">
              <h1 className="text-xl font-black text-white tracking-tighter">JAKE WorkOS <span className="text-xs bg-blue-600 px-1.5 py-0.5 rounded ml-1">V8</span></h1>
              <button className="lg:hidden text-slate-400" onClick={() => setIsOpen(false)}>âœ•</button>
            </div>
            <nav className="p-4 space-y-8 overflow-y-auto h-[calc(100vh-80px)] no-scrollbar">
              {menus.map(group => (
                <div key={group.group}>
                  <p className="text-[10px] font-bold text-slate-500 mb-3 ml-2 uppercase tracking-widest">{group.group}</p>
                  <div className="space-y-1">
                    {group.items.map(item => (
                      <button
                        key={item.id}
                        onClick={() => { setActiveTab(item.id); setIsOpen(false); }}
                        className={`w-full flex items-center px-3 py-2.5 rounded-lg font-bold text-sm transition-all ${activeTab === item.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 hover:text-white'}`}
                      >
                        <span className="mr-3 text-lg">{item.icon}</span> {item.label}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </nav>
          </aside>
        </>
      );
    }

    // ==========================================
    // ğŸ“Š View: Unified Dashboard (Calendar)
    // ==========================================
    function DashboardView() {
      const [loading, setLoading] = useState(true);
      const [events, setEvents] = useState([]); // Integrated Events
      const [currentDate, setCurrentDate] = useState(new Date());

      const fetchAllData = useCallback(async () => {
        setLoading(true);
        try {
          // 1. Fetch tables in parallel (Multi-Source Fetching)
          const [burialRes, salesRes] = await Promise.all([
            supabaseClient.from('burial_schedule').select('*'),
            supabaseClient.from('status_mgmt').select('*')
          ]);

          // 2. Client-side Merging (First Principles: Avoid rigid SQL joins)
          const burialEvents = (burialRes.data || []).map(b => ({
            type: 'burial',
            date: normalizeDate(b.ì•ˆì¹˜ì¼),
            title: `ğŸŸ¢ ${clean(b.ê³ ì¸ëª…)}`,
            sub: clean(b.ìœ„ì¹˜),
            raw: b
          }));

          const salesEvents = (salesRes.data || []).map(s => ({
            type: 'sales',
            date: normalizeDate(s.ë‹µì‚¬ì¼) || normalizeDate(s.ë“±ë¡ì¼),
            title: `ğŸŸ¡ ${clean(s.ê³ ê°_ê³ ì¸_ëª…)}`,
            sub: `${clean(s.ì˜ì—…ìì‚¬ëª…)}/${clean(s.ì˜ì—…ìì„±í•¨)}`,
            status: s.í˜„ì¬ìƒíƒœ,
            raw: s
          })).filter(s => s.status !== 'ìƒë‹´ í›„ ëŒ€ê¸°');

          // 3. Combine everything
          setEvents([...burialEvents, ...salesEvents].filter(e => e.date !== null));
        } catch (err) {
          console.error("Data Load Error:", err);
        } finally {
          setLoading(false);
        }
      }, []);

      useEffect(() => { fetchAllData(); }, [fetchAllData]);

      const calendarDays = useMemo(() => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const startDay = new Date(year, month, 1).getDay();
        const offset = startDay === 0 ? 6 : startDay - 1; // Mon Start
        const lastDate = new Date(year, month + 1, 0).getDate();
        
        const days = [];
        for (let i = 0; i < offset; i++) days.push(null);
        for (let i = 1; i <= lastDate; i++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          days.push({ day: i, dateStr, dayEvents: events.filter(e => e.date === dateStr) });
        }
        return days;
      }, [currentDate, events]);

      return (
        <div className="space-y-6 max-w-7xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
            <div className="p-6 bg-white border-b border-slate-100 flex justify-between items-center">
              <div className="flex items-center space-x-4">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 hover:bg-slate-100 rounded-full transition">â—€</button>
                <h2 className="text-2xl font-black text-slate-800 tracking-tight">{currentDate.getFullYear()}ë…„ {currentDate.getMonth() + 1}ì›”</h2>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 hover:bg-slate-100 rounded-full transition">â–¶</button>
              </div>
              <div className="flex space-x-2 text-xs font-bold">
                <span className="px-2 py-1 bg-emerald-100 text-emerald-700 rounded border border-emerald-200">ğŸŸ¢ ì•ˆì¹˜ì¼ì •</span>
                <span className="px-2 py-1 bg-amber-100 text-amber-700 rounded border border-amber-200">ğŸŸ¡ ì˜ì—…/ë‹µì‚¬</span>
              </div>
            </div>

            <div className="calendar-grid">
              {['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'].map((d, i) => (
                <div key={d} className={`p-3 text-center text-xs font-black bg-slate-50 border-b border-slate-200 ${i === 6 ? 'text-red-500' : i === 5 ? 'text-blue-500' : 'text-slate-400'}`}>{d}</div>
              ))}
              {calendarDays.map((d, i) => (
                <div key={i} className={`calendar-cell ${!d ? 'bg-slate-50/30' : ''}`}>
                  {d && (
                    <>
                      <div className="text-right font-bold text-xs text-slate-400 mb-1">{d.day}</div>
                      <div className="space-y-1 max-h-[85px] overflow-y-auto no-scrollbar">
                        {d.dayEvents.map((ev, idx) => (
                          <div key={idx} className={`px-1.5 py-1 rounded text-[10px] font-bold truncate border shadow-sm ${ev.type === 'burial' ? 'bg-emerald-600 text-white border-emerald-700' : 'bg-amber-400 text-amber-900 border-amber-500'}`}>
                            {ev.title}
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // ğŸ” View: Field Grid Map
    // ==========================================
    function FieldView() {
      const [loading, setLoading] = useState(true);
      const [data, setData] = useState([]);
      const [area, setArea] = useState('A6/ê°€');

      useEffect(() => {
        const fetchField = async () => {
          setLoading(true);
          const { data } = await supabaseClient.from('field_data').select('*').eq('êµ¬ì—­', area).order('ìœ„ì¹˜_ë²ˆí˜¸', { ascending: true });
          setData(data || []);
          setLoading(false);
        };
        fetchField();
      }, [area]);

      const sectionList = ['A2/ê°€','A3/ê°€','A4/ê°€','A4/ë‚˜','A4/ë‹¤','A5/ê°€','A5/ë‚˜','A6/ê°€','A6/ë‚˜','B1/ê°€','B2/ê°€','B3/ê°€','B4/ê°€','B5/ê°€','B6/ê°€/1-12','B6/ê°€/13-14','C1/ê°€'];

      return (
        <div className="space-y-6 max-w-7xl mx-auto">
          <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar shrink-0">
            {sectionList.map(s => (
              <button 
                key={s} 
                onClick={() => setArea(s)}
                className={`px-4 py-2 rounded-xl font-bold text-xs whitespace-nowrap transition-all border shadow-sm ${area === s ? 'bg-slate-800 text-white border-slate-800 scale-105' : 'bg-white text-slate-500 border-slate-200 hover:border-slate-400'}`}
              >
                {s}
              </button>
            ))}
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-xl border border-slate-200 min-h-[500px]">
            {loading ? <div className="p-40 text-center font-bold text-slate-300 animate-pulse">MAP RENDERING...</div> : (
              <div className="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12 gap-3">
                {data.map((item, idx) => {
                  const status = clean(item.ê³„ì•½_ìƒíƒœ) || 'ë¯¸ë¶„ì–‘';
                  const colors = {
                    'ì•ˆì¹˜': 'bg-emerald-600 text-white border-emerald-700',
                    'ì˜ˆì•½': 'bg-amber-400 text-amber-900 border-amber-500 font-black',
                    'ê³„ì•½ê¸ˆ': 'bg-amber-100 text-amber-700 border-amber-200',
                    'í™€ë”©': 'bg-rose-600 text-white border-rose-700',
                    'ë¯¸ë¶„ì–‘': 'bg-slate-50 text-slate-300 border-slate-100'
                  };
                  return (
                    <div key={idx} className={`aspect-square rounded-xl border flex flex-col items-center justify-center p-2 text-center transition-transform hover:scale-110 cursor-pointer shadow-sm ${colors[status] || colors['ë¯¸ë¶„ì–‘']}`}>
                      <div className="text-[9px] opacity-70 mb-1">{item.ìœ„ì¹˜_ë²ˆí˜¸}</div>
                      <div className="text-[11px] font-black leading-tight truncate w-full">{clean(item.ì„±í•¨) || clean(item.ê³„ì•½ì) || (status === 'ë¯¸ë¶„ì–‘' ? 'EMPTY' : status)}</div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    }

    // ==========================================
    // âš™ï¸ Main Application Controller
    // ==========================================
    function App() {
      const [activeTab, setActiveTab] = useState('dash');
      const [isSidebarOpen, setIsSidebarOpen] = useState(false);

      return (
        <div className="flex h-screen overflow-hidden">
          <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} isOpen={isSidebarOpen} setIsOpen={setIsSidebarOpen} />
          
          <main className="flex-1 flex flex-col h-screen overflow-hidden">
            <header className="h-16 bg-white border-b border-slate-200 flex items-center px-6 shrink-0 justify-between z-30">
              <div className="flex items-center">
                <button className="lg:hidden p-2 text-slate-500 bg-slate-100 rounded-lg mr-4" onClick={() => setIsSidebarOpen(true)}>â˜°</button>
                <h2 className="font-black text-xl text-slate-800 uppercase tracking-tighter">
                  {activeTab === 'dash' ? 'Integrated Dashboard' : activeTab === 'field' ? 'Field Management' : activeTab}
                </h2>
              </div>
              <div className="flex items-center space-x-4">
                <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse" title="Supabase Connected" />
                <span className="text-[10px] font-black text-slate-400">JAKE ZEPHYRUS-G14 // CONNECTED</span>
              </div>
            </header>

            <div className="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar bg-[#F8FAFC]">
              {activeTab === 'dash' && <DashboardView />}
              {activeTab === 'field' && <FieldView />}
              {['hr', 'project', 'engraving', 'meeting', 'contact'].includes(activeTab) && (
                <div className="flex flex-col items-center justify-center h-full text-slate-300">
                  <span className="text-6xl mb-4">âš™ï¸</span>
                  <p className="font-black text-xl uppercase tracking-widest italic">Module "{activeTab}" under construction</p>
                  <p className="text-sm mt-2 font-bold text-slate-400">Phase 6: WorkOS Core Porting scheduled next.</p>
                </div>
              )}
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
