<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Jake WorkOS V22 - Back to Basics</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
    body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; color: #1e293b; -webkit-font-smoothing: antialiased; overflow: hidden; }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f8fafc; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f8fafc; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e2e8f0; border: 1px solid #e2e8f0; }
    .calendar-cell { min-height: 100px; background-color: #fff; padding: 4px; cursor: pointer; transition: background-color 0.2s; }
    .calendar-cell:hover { background-color: #f8fafc; }
    .calendar-cell:active { background-color: #f1f5f9; }
    
    .modal-enter { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

    /* ğŸ—ºï¸ í˜„ì¥ ì§€ë„ ë Œë”ë§ ë¬¼ë¦¬ ì—”ì§„ (ìš°ì¸¡ ì˜ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ w-maxì—ì„œ min-w-max ê³„ì—´ë¡œ ë³€ê²½) */
    .map-row { display: flex; flex-direction: row; justify-content: flex-start; gap: 4px; margin-bottom: 4px; width: max-content; }
    .map-slot { width: 85px; min-width: 85px; height: 70px; border-radius: 4px; border: 1px solid #cbd5e1; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.1s; }
    .map-slot:active { opacity: 0.7; transform: scale(0.95); }
    .slot-spacer { visibility: hidden; pointer-events: none; border: none; background: transparent; } 
    .slot-id { font-size: 10px; font-weight: 800; margin-bottom: 2px; }
    .slot-name { font-size: 11px; font-weight: 800; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; letter-spacing: -0.5px; }

    /* ëª¨ë‹¬ í¼ ìŠ¤íƒ€ì¼ */
    .form-input { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; font-weight: bold; color: #1e293b; outline: none; transition: border-color 0.2s; background-color: #f8fafc; }
    .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); background-color: #ffffff; }
    .form-label { display: block; font-size: 11px; font-weight: 900; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const SUPABASE_URL = 'https://lqccxnciiajwqdmpwjdv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxY2N4bmNpaWFqd3FkbXB3amR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjA3MTMsImV4cCI6MjA4NzA5NjcxM30.L23-eq-DIPsbONOeX-xQ8UcMb7gtgTTTRpkaSm9HTw4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const clean = (val) => (!val || val === '0.0' || val === '0' || val === 'null' || val === ' -  - ' || val === 'SPACER') ? '' : String(val).trim();
    const normalizeDate = (v) => { 
      if(!v) return null; 
      try {
        const s = String(v).replace(/\./g,'-').replace(/\s/g,'').substring(0,10);
        const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
        return m ? `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}` : null;
      } catch(e) { return null; }
    };
    const formatMoney = (val) => {
      try {
        const num = parseInt(String(val).replace(/[^0-9]/g, ''));
        return isNaN(num) ? '0ì›' : num.toLocaleString() + 'ì›';
      } catch(e) { return '0ì›'; }
    };
    const getTodayStr = () => new Date().toISOString().split('T')[0];

    const SECTION_LIST = ['A2/ê°€','A3/ê°€','A4/ê°€','A4/ë‚˜','A4/ë‹¤','A5/ê°€','A5/ë‚˜','A6/ê°€','A6/ë‚˜','B1/ê°€','B2/ê°€','B3/ê°€','B4/ê°€','B5/ê°€','B6/ê°€/1-12','B6/ê°€/13-14','C1/ê°€'];
    const ROW_CONFIG = { 
      'A2/ê°€':[12], 'A3/ê°€':[8,8], 'A4/ê°€':[12,12,12,12,18,18,28,12], 'A4/ë‚˜':[9,11,7,8,8], 'A4/ë‹¤':[6,6], 'A5/ê°€':[13,14,14,13,13,15,11], 
      'A5/ë‚˜':[23,22,26,25,30,47,47,30,39], 'A6/ê°€':[27,27,22,18,19,15,13], 'A6/ë‚˜':[25,26,26,26,26,26], 'C1/ê°€':[13,17,21,25], 
      'B1/ê°€':[20,23], 'B2/ê°€':[34,34,35,34,34], 'B3/ê°€':[48,46,45,41], 'B4/ê°€':[37,38,41,41,34], 'B5/ê°€':[47,47,49,48,40,32], 
      'B6/ê°€/1-12':[47,52,53,52,53,53,54,54,54,53,55,54,50], 'B6/ê°€/13-14':[75,75,75,75,75,75,75,75,75] 
    };

    class ErrorBoundary extends React.Component {
      constructor(props) { super(props); this.state = { hasError: false, error: null }; }
      static getDerivedStateFromError(error) { return { hasError: true, error }; }
      render() {
        if (this.state.hasError) {
          return (
            <div className="p-8 m-4 bg-rose-50 border-2 border-rose-500 rounded-xl shadow-lg">
              <h1 className="text-xl font-black text-rose-700 mb-2">ğŸš¨ V22 ì‹œìŠ¤í…œ ì˜¤ë¥˜</h1>
              <pre className="text-xs bg-white p-4 rounded border border-rose-200 overflow-auto">{this.state.error?.toString()}</pre>
            </div>
          );
        }
        return this.props.children; 
      }
    }

    // ğŸ§± ë‹¤ì¤‘ ëª¨ë‹¬ ì»´í¬ë„ŒíŠ¸
    function Modal({ isOpen, onClose, title, children, isNested = false }) {
      if (!isOpen) return null;
      const zIndex = isNested ? "z-[110]" : "z-[100]"; 
      const bgOpacity = isNested ? "bg-slate-900/40" : "bg-slate-900/60";

      return (
        <div className={`fixed inset-0 flex items-center justify-center p-4 ${bgOpacity} ${zIndex}`} onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[85vh] overflow-hidden flex flex-col modal-enter" onClick={e => e.stopPropagation()}>
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
              <h3 className="text-lg font-black text-slate-800 tracking-tight">{title}</h3>
              <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-lg text-slate-500 font-bold transition">âœ•</button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 bg-slate-50/50 relative">{children}</div>
          </div>
        </div>
      );
    }

    // ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ
    function DashboardView() {
      const [loading, setLoading] = useState(true);
      const [events, setEvents] = useState([]);
      const [currentDate, setCurrentDate] = useState(new Date());
      
      const [dailyModal, setDailyModal] = useState({ isOpen: false, dateStr: '', events: [] });
      const [undecidedModalOpen, setUndecidedModalOpen] = useState(false);
      const [salesModal, setSalesModal] = useState({ isOpen: false, data: null });
      const [schModal, setSchModal] = useState({ isOpen: false, data: null });

      useEffect(() => {
        const fetchAll = async () => {
          setLoading(true);
          try {
            const [burRes, salRes] = await Promise.all([
              supabaseClient.from('burial_schedule').select('*'),
              supabaseClient.from('status_mgmt').select('*')
            ]);
            const bEvs = (burRes.data || []).map(b => ({ id: b.id, type:'burial', date:normalizeDate(b.ì•ˆì¹˜ì¼), title:clean(b.ê³ ì¸ëª…), sub:clean(b.ìœ„ì¹˜), raw:b }));
            const sEvs = (salRes.data || []).map(s => {
              const custName = clean(s['ê³ ê°(ê³ ì¸)ëª…'] || s.ê³ ê°_ê³ ì¸_ëª… || s.ê³ ê°ê³ ì¸ëª… || 'ì´ë¦„ì—†ìŒ');
              return { id: s.id, type:'sales', date:normalizeDate(s.ë‹µì‚¬ì¼)||normalizeDate(s.ë“±ë¡ì¼), title:custName, sub:`${clean(s.ì˜ì—…ìì‚¬ëª…)}/${clean(s.ì˜ì—…ìì„±í•¨)}`, status:s.í˜„ì¬ìƒíƒœ, raw:s };
            });
            setEvents([...bEvs, ...sEvs].filter(e => e.date !== null));
          } catch (e) { console.error(e); } finally { setLoading(false); }
        };
        fetchAll();
      }, []);

      const calendarDays = useMemo(() => {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        const startDay = new Date(year, month, 1).getDay(), offset = startDay === 0 ? 6 : startDay - 1;
        const lastDate = new Date(year, month + 1, 0).getDate();
        const days = [];
        for (let i = 0; i < offset; i++) days.push(null);
        for (let i = 1; i <= lastDate; i++) {
          const ds = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
          days.push({ day: i, dateStr: ds, dayEvents: events.filter(e => e.date === ds && e.status !== 'ìƒë‹´ í›„ ëŒ€ê¸°') });
        }
        return days;
      }, [currentDate, events]);

      const headlineStats = useMemo(() => {
        const targetDate = dailyModal.isOpen ? dailyModal.dateStr : getTodayStr();
        const todaysEvents = events.filter(e => e.date === targetDate);
        const burials = todaysEvents.filter(e => e.type === 'burial').length;
        const sales = todaysEvents.filter(e => e.type === 'sales' && (e.status === 'ë‹µì‚¬ëŒ€ê¸°' || e.status === 'ë‹µì‚¬ì™„ë£Œ')).length;
        return { targetDate, burials, sales, hr: 0 };
      }, [events, dailyModal.isOpen, dailyModal.dateStr]);

      const undecidedList = useMemo(() => {
        return events.filter(e => e.type === 'sales' && e.status !== 'ì•ˆì¹˜í™•ì •' && e.status !== 'ì·¨ì†Œ');
      }, [events]);

      const handleCellClick = (dateStr, dayEvents) => {
        setDailyModal({ isOpen: true, dateStr, events: dayEvents });
      };

      return (
        <div className="space-y-4 max-w-7xl mx-auto h-full flex flex-col">
          <div className="bg-slate-800 rounded-2xl p-4 shadow-lg text-white flex justify-between items-center shrink-0">
            <div>
              <p className="text-xs font-bold text-slate-400 mb-1">
                {headlineStats.targetDate === getTodayStr() ? 'TODAY SUMMARY' : `SUMMARY: ${headlineStats.targetDate}`}
              </p>
              <div className="flex gap-4">
                <div className="flex items-end gap-1"><span className="text-2xl font-black text-emerald-400">{headlineStats.burials}</span><span className="text-sm font-bold text-slate-300 pb-1">ì•ˆì¹˜</span></div>
                <div className="flex items-end gap-1"><span className="text-2xl font-black text-amber-400">{headlineStats.sales}</span><span className="text-sm font-bold text-slate-300 pb-1">ë‹µì‚¬</span></div>
                <div className="flex items-end gap-1"><span className="text-2xl font-black text-blue-400">{headlineStats.hr}</span><span className="text-sm font-bold text-slate-300 pb-1">íœ´ë¬´</span></div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow border border-slate-200 flex flex-col h-full overflow-hidden">
            <div className="p-4 border-b border-slate-100 flex justify-between items-center shrink-0">
              <div className="flex items-center space-x-4">
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1, 1))} className="px-3 py-1 bg-slate-100 hover:bg-slate-200 transition rounded-lg font-bold">â—€</button>
                <h2 className="text-xl font-black">{currentDate.getFullYear()}ë…„ {currentDate.getMonth()+1}ì›”</h2>
                <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 1))} className="px-3 py-1 bg-slate-100 hover:bg-slate-200 transition rounded-lg font-bold">â–¶</button>
              </div>
            </div>
            
            <div className="px-4 pt-4 shrink-0">
              <button onClick={() => setUndecidedModalOpen(true)} className="w-full bg-orange-50 hover:bg-orange-100 transition text-orange-600 border border-orange-200 font-black py-3 rounded-xl shadow-sm flex justify-between px-4">
                  <span>ğŸ“ ì˜ì—… ëŒ€ê¸° ë° ì„ ì  ëª…ë‹¨ í™•ì¸</span>
                  <span className="bg-orange-600 text-white px-2 py-0.5 rounded-lg">{undecidedList.length}ê±´</span>
              </button>
            </div>

            <div className="flex-1 overflow-auto bg-white p-2 md:p-4">
              <div className="min-w-[700px] h-full flex flex-col border border-slate-200 rounded-xl shadow-sm bg-slate-200 gap-px">
                <div className="grid grid-cols-7 gap-px shrink-0">
                  {['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].map((d,i)=>(<div key={d} className={`py-2 text-center text-sm font-black bg-white ${i===6?'text-red-500':i===5?'text-blue-500':'text-slate-700'}`}>{d}</div>))}
                </div>
                <div className="grid grid-cols-7 gap-px flex-1">
                  {calendarDays.map((d,i)=>(
                    <div key={i} onClick={()=>d && handleCellClick(d.dateStr, d.dayEvents)} className={`calendar-cell flex flex-col ${!d?'bg-slate-50 cursor-default':''}`}>
                      {d && (
                        <>
                          <div className={`text-right text-xs font-bold p-1 ${getTodayStr() === d.dateStr ? 'text-white bg-blue-600 inline-block self-end rounded-md px-2' : 'text-slate-500'}`}>{d.day}</div>
                          <div className="space-y-1 overflow-y-auto no-scrollbar pb-1">
                            {d.dayEvents.map((ev,idx)=>{
                              const isCancel = ev.status === 'ì·¨ì†Œ';
                              const isDone = ev.status === 'ë‹µì‚¬ì™„ë£Œ' || ev.status === 'ì•ˆì¹˜í™•ì •';
                              let st = ev.type === 'burial' ? 'bg-emerald-600 text-white' : (isCancel ? 'bg-slate-200 text-slate-500 line-through' : isDone ? 'bg-blue-100 text-blue-800' : 'bg-amber-300 text-amber-900');
                              return <div key={idx} className={`px-1.5 py-0.5 rounded text-[10px] font-bold truncate shadow-sm ${st}`}>{ev.title}</div>
                            })}
                          </div>
                        </>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>

          <Modal isOpen={dailyModal.isOpen} onClose={()=>setDailyModal({...dailyModal, isOpen:false})} title={`ğŸ“… ${dailyModal.dateStr} ì¼ì •`}>
            {dailyModal.events.length === 0 ? <div className="text-center p-8 text-slate-400 font-bold">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div> : (
              <div className="space-y-2">
                {dailyModal.events.map((ev, idx) => {
                  const isCancel = ev.status === 'ì·¨ì†Œ';
                  const isDone = ev.status === 'ë‹µì‚¬ì™„ë£Œ' || ev.status === 'ì•ˆì¹˜í™•ì •';
                  if (ev.type === 'sales') {
                    const bg = isCancel ? "bg-slate-100 text-slate-500" : (isDone ? "bg-blue-50 border-blue-200" : "bg-yellow-50 border-amber-300 hover:bg-yellow-100");
                    return (
                      <div key={idx} onClick={() => { setDailyModal({...dailyModal, isOpen:false}); setSalesModal({isOpen:true, data:ev}); }} className={`p-3 rounded-xl border cursor-pointer transition shadow-sm ${bg}`}>
                        <div className="font-black text-[13px] mb-1" style={{textDecoration: isCancel ? "line-through" : "none"}}>ğŸŸ¡ [ì˜ì—…] {ev.sub} - {ev.title} <span className="float-right text-[11px] bg-white/50 px-1.5 rounded">{ev.status}</span></div>
                        <div className="text-[11px] font-bold opacity-70 whitespace-pre-wrap">{clean(ev.raw.ë¹„ê³ ë©”ëª¨) || 'ë©”ëª¨ ì—†ìŒ'}</div>
                      </div>
                    );
                  } else {
                    return (
                      <div key={idx} onClick={() => { setDailyModal({...dailyModal, isOpen:false}); setSchModal({isOpen:true, data:ev}); }} className="p-3 rounded-xl border border-emerald-700 bg-emerald-600 text-white cursor-pointer hover:bg-emerald-700 transition shadow-sm">
                        <div className="font-black text-[13px] mb-1">ğŸŸ¢ [ì•ˆì¹˜] {ev.title} <span className="float-right text-[11px] bg-black/20 px-1.5 rounded">{ev.sub}</span></div>
                        <div className="text-[11px] font-medium opacity-90 whitespace-pre-wrap">{clean(ev.raw.ë¹„ê³ ) || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ'}</div>
                      </div>
                    );
                  }
                })}
              </div>
            )}
            <div className="mt-4 flex gap-2">
                <button onClick={() => { setDailyModal({...dailyModal, isOpen:false}); setSalesModal({isOpen:true, data:null}); }} className="flex-1 py-3 bg-amber-50 text-amber-700 border border-amber-200 font-bold rounded-xl text-sm shadow-sm hover:bg-amber-100 transition">+ ì˜ì—… ë“±ë¡</button>
                <button onClick={() => { setDailyModal({...dailyModal, isOpen:false}); setSchModal({isOpen:true, data:null}); }} className="flex-1 py-3 bg-emerald-50 text-emerald-700 border border-emerald-200 font-bold rounded-xl text-sm shadow-sm hover:bg-emerald-100 transition">+ ì•ˆì¹˜ ë“±ë¡</button>
            </div>
          </Modal>

          <Modal isOpen={undecidedModalOpen} onClose={()=>setUndecidedModalOpen(false)} title="ğŸ“ ì˜ì—… ëŒ€ê¸° ë° ì„ ì  ëª…ë‹¨">
              <div className="space-y-2 max-h-[60vh] overflow-y-auto no-scrollbar">
                  {undecidedList.map(ev => (
                      <div key={ev.id} onClick={() => { setUndecidedModalOpen(false); setSalesModal({isOpen:true, data:ev}); }} className="p-3 bg-white border border-orange-200 rounded-xl cursor-pointer hover:bg-orange-50 shadow-sm transition">
                          <div className="flex justify-between items-center mb-1.5">
                              <span className="font-black text-[14px] text-slate-800">{ev.title} <span className="text-slate-500 font-bold text-[12px]">({ev.sub})</span></span>
                              <span className="text-[10px] font-black text-orange-600 bg-orange-100 px-2 py-0.5 rounded">{ev.status}</span>
                          </div>
                          <div className="text-[12px] font-bold text-blue-600 mb-1">ğŸ“ {ev.raw?.ì—°ë½ì²˜ || 'ì—°ë½ì²˜ ì—†ìŒ'}</div>
                          <div className="text-[11px] text-slate-500 font-bold">â° ì°œ ë“±ë¡: {normalizeDate(ev.raw?.ë“±ë¡ì¼) || '-'}</div>
                      </div>
                  ))}
                  {undecidedList.length === 0 && <div className="text-center p-5 text-slate-400 font-bold">ëŒ€ê¸° ì¤‘ì¸ ì„ ì  ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
              </div>
          </Modal>

          <Modal isOpen={salesModal.isOpen} onClose={()=>setSalesModal({isOpen:false, data:null})} title={salesModal.data ? "ğŸŸ¡ ì˜ì—… í˜„í™© ìˆ˜ì •" : "ğŸ“ ì˜ì—… í˜„í™© ì‹ ê·œ ë“±ë¡"} isNested={true}>
              <div className="space-y-4">
                  <div className="input-group">
                      <label className="form-label">ë“±ë¡(ì°œ) ì¼ì‹œ</label>
                      <input type="text" className="form-input bg-yellow-50 border-yellow-300 text-red-600" defaultValue={normalizeDate(salesModal.data?.raw?.ë“±ë¡ì¼) || ''} placeholder="ë¹„ì›Œë‘ë©´ í˜„ì¬ ì‹œê°„ ê¸°ë¡" />
                  </div>
                  <div className="input-group">
                      <label className="form-label">ë‹µì‚¬ ì˜ˆì •ì¼</label>
                      <input type="date" className="form-input" defaultValue={normalizeDate(salesModal.data?.raw?.ë‹µì‚¬ì¼) || (dailyModal.isOpen ? dailyModal.dateStr : '')} />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div>
                          <label className="form-label">ì‚¬ëª… (ì—…ì²´ëª…)</label>
                          <input type="text" className="form-input" defaultValue={clean(salesModal.data?.raw?.ì˜ì—…ìì‚¬ëª…) || ''} placeholder="ì˜ˆ: ê°œì¸" />
                      </div>
                      <div>
                          <label className="form-label">ì˜ì—…ì ì„±í•¨</label>
                          <input type="text" className="form-input" defaultValue={clean(salesModal.data?.raw?.ì˜ì—…ìì„±í•¨) || ''} />
                      </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div>
                          <label className="form-label">ê³ ê°(ê³ ì¸)ëª…</label>
                          <input type="text" className="form-input" defaultValue={salesModal.data?.title || ''} />
                      </div>
                      <div>
                          <label className="form-label">ì—°ë½ì²˜</label>
                          <input type="text" className="form-input" defaultValue={clean(salesModal.data?.raw?.ì—°ë½ì²˜) || ''} />
                      </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div>
                          <label className="form-label">ê³„ì•½êµ¬ë¶„</label>
                          <select className="form-input" defaultValue={clean(salesModal.data?.raw?.ê³„ì•½êµ¬ë¶„) || 'ì„ ë¶„ì–‘'}>
                              <option value="ì„ ë¶„ì–‘">ì„ ë¶„ì–‘</option>
                              <option value="ì¥ë¡€ì•ˆì¹˜">ì¥ë¡€ì•ˆì¹˜</option>
                          </select>
                      </div>
                      <div>
                          <label className="form-label">ì§„í–‰ìƒíƒœ</label>
                          <select className="form-input cursor-pointer font-black text-blue-600" defaultValue={clean(salesModal.data?.status) || 'ìƒë‹´ í›„ ëŒ€ê¸°'}>
                              <option value="ìƒë‹´ í›„ ëŒ€ê¸°">ìƒë‹´ í›„ ëŒ€ê¸°</option>
                              <option value="ë‹µì‚¬ëŒ€ê¸°">ë‹µì‚¬ëŒ€ê¸°</option>
                              <option value="ë‹µì‚¬ì™„ë£Œ">ë‹µì‚¬ì™„ë£Œ</option>
                              <option value="ì•ˆì¹˜í™•ì •" className="text-red-500">ì•ˆì¹˜í™•ì •</option>
                              <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                          </select>
                      </div>
                  </div>
                  <div className="input-group">
                      <label className="form-label text-red-500">ğŸš¨ ì•ˆì¹˜ í™•ì •ì¼ (ìë™ ìƒì„±ìš©)</label>
                      <input type="date" className="form-input border-red-200 bg-red-50" defaultValue={normalizeDate(salesModal.data?.raw?.ì•ˆì¹˜í™•ì •ì¼) || ''} />
                  </div>
                  <div className="input-group">
                      <label className="form-label">ë¹„ê³  ë©”ëª¨</label>
                      <textarea className="form-input min-h-[80px]" defaultValue={clean(salesModal.data?.raw?.ë¹„ê³  || salesModal.data?.raw?.ë¹„ê³ ë©”ëª¨)} placeholder="íŠ¹ì´ì‚¬í•­..."></textarea>
                  </div>
                  <div className="flex gap-2 pt-2">
                      {salesModal.data && <button className="flex-1 py-3 bg-red-50 text-red-600 font-black rounded-xl text-sm border border-red-100 hover:bg-red-100 transition">ì‚­ì œ (ë³´ê´€)</button>}
                      <button className="flex-[2] py-3 bg-blue-600 text-white font-black rounded-xl text-sm hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">ë°ì´í„° ì €ì¥</button>
                  </div>
              </div>
          </Modal>

          <Modal isOpen={schModal.isOpen} onClose={()=>setSchModal({isOpen:false, data:null})} title={schModal.data ? "ğŸŸ¢ ì•ˆì¹˜ ì¼ì • ìˆ˜ì •" : "ğŸŸ¢ ì•ˆì¹˜ ì¼ì • ë“±ë¡"} isNested={true}>
              <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                      <div>
                          <label className="form-label">ì•ˆì¹˜ì¼</label>
                          <input type="date" className="form-input" defaultValue={normalizeDate(schModal.data?.raw?.ì•ˆì¹˜ì¼) || (dailyModal.isOpen ? dailyModal.dateStr : '')} />
                      </div>
                      <div>
                          <label className="form-label">ê³„ì•½ë²ˆí˜¸</label>
                          <input type="text" className="form-input" defaultValue={clean(schModal.data?.raw?.ê³„ì•½ë²ˆí˜¸) || ''} placeholder="ì‹¤ì ìš©" />
                      </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                      <div>
                          <label className="form-label">ê³ ì¸ëª…</label>
                          <input type="text" className="form-input" defaultValue={clean(schModal.data?.raw?.ê³ ì¸ëª…) || ''} />
                      </div>
                      <div>
                          <label className="form-label">ê³„ì•½ì</label>
                          <input type="text" className="form-input" defaultValue={clean(schModal.data?.raw?.ê³„ì•½ì) || ''} />
                      </div>
                  </div>
                  <div className="input-group">
                      <label className="form-label text-blue-600">ìœ„ì¹˜ì •ë³´ (ì§€ë„ ì „ì†¡ìš©)</label>
                      <input type="text" className="form-input border-blue-200 bg-blue-50" defaultValue={clean(schModal.data?.raw?.ìœ„ì¹˜) || ''} placeholder="ì˜ˆ: B6/ê°€/ë°˜ì†¡/4-9[1]" />
                  </div>
                  <div className="input-group">
                      <label className="form-label">ë¹„ê³ </label>
                      <textarea className="form-input min-h-[80px]" defaultValue={clean(schModal.data?.raw?.ë¹„ê³ )} placeholder="íŠ¹ì´ì‚¬í•­..."></textarea>
                  </div>
                  <div className="flex gap-2 pt-2">
                      {schModal.data && <button className="flex-1 py-3 bg-red-50 text-red-600 font-black rounded-xl text-sm border border-red-100 hover:bg-red-100 transition">ì‚­ì œ</button>}
                      <button className="flex-[2] py-3 bg-emerald-600 text-white font-black rounded-xl text-sm hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/30">ë°ì´í„° ì €ì¥</button>
                  </div>
              </div>
          </Modal>

        </div>
      );
    }

    // ğŸ“ í˜„ì¥ ì§€ë„ ë·° (JSON ë¹„ë™ê¸° ë¡œë”© = ì›ì²œ í•˜ì–€ í™”ë©´ ë°©ì§€)
    function FieldView() {
      const [loading, setLoading] = useState(true);
      const [data, setData] = useState([]);
      const [area, setArea] = useState('A2/ê°€');
      const [slotModal, setSlotModal] = useState({ isOpen: false, data: null });
      const [layoutData, setLayoutData] = useState({});

      useEffect(() => {
        // âœ”ï¸ ì—¬ê¸°ì„œ JSONì„ ë³„ë„ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ë•Œë¬¸ì— ë©”ì¸ ì½”ë“œê°€ ê°€ë²¼ì›Œì§‘ë‹ˆë‹¤!
        fetch('/map_layout.json')
          .then(res => res.json())
          .then(json => setLayoutData(json))
          .catch(err => console.error("JSON Fetch Error:", err));
      }, []);

      useEffect(() => {
        const fetchField = async () => {
          setLoading(true);
          try {
            const res = await supabaseClient.from('field_data').select('*').eq('êµ¬ì—­', area);
            setData(res.data || []);
          } catch(e) { console.error("DB Fetch Error:", e); }
          setLoading(false);
        };
        fetchField();
      }, [area]);

      const renderedGrid = useMemo(() => {
        if (!layoutData || !layoutData[area]) return [];
        const dataMap = {};
        data.forEach(item => { if (item.ìœ„ì¹˜_ë²ˆí˜¸) dataMap[item.ìœ„ì¹˜_ë²ˆí˜¸] = item; });

        const comp = layoutData[area];
        let finalRows = [];

        if (Array.isArray(comp[0])) {
            finalRows = comp;
        } else {
            const flat = [];
            comp.forEach(item => {
                if (typeof item === 'string' && item.startsWith('_')) {
                    const count = parseInt(item.substring(1)) || 1;
                    for(let i=0; i<count; i++) flat.push('SPACER');
                } else {
                    flat.push(item);
                }
            });
            const config = ROW_CONFIG[area] || [20];
            let idx = 0;
            config.forEach(cnt => {
                if(idx < flat.length) {
                    finalRows.push(flat.slice(idx, idx + cnt));
                    idx += cnt;
                }
            });
        }

        return finalRows.map((rowSlots, rIdx) => ({
            rowNum: rIdx + 1,
            slots: rowSlots.map((slotId, sIdx) => {
                if (!slotId || slotId === 'SPACER' || (typeof slotId === 'string' && slotId.startsWith('_'))) {
                     return { type: 'spacer', id: `spacer-${rIdx}-${sIdx}` };
                }
                return { type: 'data', ...(dataMap[slotId] || { ìœ„ì¹˜_ë²ˆí˜¸: slotId, êµ¬ì—­: area, ê³„ì•½_ìƒíƒœ: 'ë¯¸ë¶„ì–‘' }) };
            })
        }));
      }, [data, area, layoutData]);

      return (
        <div className="space-y-4 max-w-7xl mx-auto flex flex-col h-[calc(100vh-100px)] overflow-hidden">
          <div className="flex gap-2 overflow-x-auto pb-2 border-b border-slate-200 px-2 w-full no-scrollbar shrink-0" style={{ WebkitOverflowScrolling: 'touch' }}>
            {SECTION_LIST.map(s => (
              <button key={s} onClick={() => setArea(s)} className={`flex-none px-4 py-2.5 rounded-t-xl font-bold text-[13px] whitespace-nowrap transition-all border-t border-l border-r ${area === s ? 'bg-white text-blue-600 border-slate-200 translate-y-[1px] shadow-[0_-2px_4px_rgba(0,0,0,0.02)]' : 'bg-slate-100 text-slate-500 border-transparent hover:bg-slate-200'}`}>
                {s}
              </button>
            ))}
          </div>

          <div className="bg-white p-4 md:p-8 rounded-b-2xl rounded-tr-2xl shadow-xl border border-slate-200 overflow-auto flex-1 relative w-full">
            {loading || Object.keys(layoutData).length === 0 ? (
              <div className="flex h-full items-center justify-center font-black text-slate-300 animate-pulse tracking-widest text-lg">MAP SYNCING...</div>
            ) : (
              <div className="min-w-max pb-20 pr-20">
                {renderedGrid.map((row, rIdx) => (
                  <div key={rIdx} className="map-row">
                    {row.slots.map((s) => {
                      if (s.type === 'spacer') return <div key={s.id} className="map-slot slot-spacer"></div>;
                      const st = clean(s.ê³„ì•½_ìƒíƒœ) || 'ë¯¸ë¶„ì–‘';
                      const cols = { 'ì•ˆì¹˜':'bg-emerald-700 text-white border-emerald-800', 'ì˜ˆì•½':'bg-amber-300 text-amber-900 border-amber-400', 'í™€ë”©':'bg-rose-600 text-white border-rose-800', 'ë¯¸ë¶„ì–‘':'bg-white text-slate-400 border-slate-300' };
                      return (
                        <div key={s.id || s.ìœ„ì¹˜_ë²ˆí˜¸} onClick={()=>setSlotModal({isOpen:true, data:s})} className={`map-slot ${cols[st] || cols['ë¯¸ë¶„ì–‘']}`}>
                          <div className={`slot-id ${st==='ë¯¸ë¶„ì–‘'?'opacity-50':''}`}>{s.ìœ„ì¹˜_ë²ˆí˜¸}</div>
                          <div className={`slot-name ${st==='ë¯¸ë¶„ì–‘'?'opacity-30':''}`}>{clean(s.ì„±í•¨) || clean(s.ê³„ì•½ì) || 'EMPTY'}</div>
                        </div>
                      );
                    })}
                  </div>
                ))}
              </div>
            )}
          </div>

          <Modal isOpen={slotModal.isOpen} onClose={()=>setSlotModal({...slotModal, isOpen:false})} title={`ğŸ“ ${slotModal.data?.êµ¬ì—­} ${slotModal.data?.ìœ„ì¹˜_ë²ˆí˜¸}`}>
            {slotModal.data && (
              <div className="space-y-4">
                <div className="flex justify-between items-center bg-slate-100 p-4 rounded-xl border border-slate-200 shadow-inner">
                  <div className="flex-1 pr-4 border-r border-slate-300">
                    <label className="form-label">ì•ˆì¹˜ì (ì„±í•¨)</label>
                    <input type="text" className="form-input bg-white text-lg font-black" defaultValue={clean(slotModal.data.ì„±í•¨)} placeholder="ì´ë¦„ ì…ë ¥" />
                  </div>
                  <div className="pl-4 w-32">
                    <label className="form-label">í˜„ì¬ ìƒíƒœ</label>
                    <select className="form-input bg-white text-blue-600 font-black cursor-pointer" defaultValue={clean(slotModal.data.ê³„ì•½_ìƒíƒœ) || 'ë¯¸ë¶„ì–‘'}>
                      <option value="ë¯¸ë¶„ì–‘">ë¯¸ë¶„ì–‘</option>
                      <option value="ì˜ˆì•½">ì˜ˆì•½</option>
                      <option value="í™€ë”©">í™€ë”©</option>
                      <option value="ì•ˆì¹˜">ì•ˆì¹˜</option>
                    </select>
                  </div>
                </div>
                
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="form-label">ê³„ì•½ì</label>
                    <input type="text" className="form-input" defaultValue={clean(slotModal.data.ê³„ì•½ì)} />
                  </div>
                  <div>
                    <label className="form-label">ê¸°ìˆ˜</label>
                    <div className="relative">
                       <input type="number" className="form-input pr-8" defaultValue={clean(slotModal.data.ê¸°ìˆ˜)} />
                       <span className="absolute right-3 top-1/2 -translate-y-1/2 font-black text-slate-400">ê¸°</span>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="form-label text-amber-600">ë¶„ì–‘ê°€</label>
                    <input type="text" className="form-input bg-amber-50 border-amber-200 text-amber-700" defaultValue={formatMoney(slotModal.data.ê°€ê²©)} />
                  </div>
                  <div>
                    <label className="form-label text-amber-600">ê´€ë¦¬ë¹„ (ì—°)</label>
                    <input type="text" className="form-input bg-amber-50 border-amber-200 text-amber-700" defaultValue={formatMoney(slotModal.data.ê´€ë¦¬ë¹„)} />
                  </div>
                </div>

                <div>
                  <label className="form-label">ë¹„ê³  (í˜„ì¥ ë©”ëª¨)</label>
                  <textarea className="form-input min-h-[80px]" defaultValue={clean(slotModal.data.ë©”ëª¨)} placeholder="íŠ¹ì´ì‚¬í•­ ê¸°ë¡..."></textarea>
                </div>

                <div className="pt-2">
                    <button className="w-full py-3 bg-blue-600 text-white font-black rounded-xl text-sm hover:bg-blue-700 transition shadow-lg shadow-blue-500/30">
                        ì§€ë„ ë°ì´í„° ì €ì¥ (DB ë™ê¸°í™”)
                    </button>
                </div>
              </div>
            )}
          </Modal>
        </div>
      );
    }

    function App() {
      const [activeTab, setActiveTab] = useState('dash');
      const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 1024);

      useEffect(() => {
        const handleResize = () => {
          if (window.innerWidth > 1024) setIsSidebarOpen(true);
          else setIsSidebarOpen(false);
        };
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      return (
        <div className="flex h-screen overflow-hidden bg-slate-900">
          {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-40 lg:hidden backdrop-blur-sm transition-opacity" onClick={() => setIsSidebarOpen(false)} />}
          
          <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 border-r border-slate-800 text-slate-300 transform transition-transform duration-300 ease-in-out lg:static lg:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:hidden'} flex flex-col shadow-2xl lg:shadow-none`}>
            <div className="p-6 border-b border-slate-800 flex justify-between items-center shrink-0">
              <h1 className="text-xl font-black text-white tracking-tighter">JAKE WorkOS <span className="text-[10px] bg-emerald-500 px-1.5 py-0.5 rounded ml-1 text-slate-900">V22</span></h1>
              <button className="lg:hidden text-slate-400 hover:text-white transition font-bold" onClick={() => setIsSidebarOpen(false)}>âœ•</button>
            </div>
            <nav className="p-4 space-y-8 overflow-y-auto flex-1 no-scrollbar">
              <div>
                <p className="text-[10px] font-black text-slate-500 mb-3 ml-2 uppercase tracking-widest">Team Workspace</p>
                <div className="space-y-1">
                  <button onClick={() => {setActiveTab('dash'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'dash' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800'}`}>ğŸ“Š í†µí•© ì¼ì • ê´€ë¦¬</button>
                  <button onClick={() => {setActiveTab('field'); if(window.innerWidth<1024)setIsSidebarOpen(false);}} className={`w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm transition-all ${activeTab === 'field' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800'}`}>ğŸ“ í˜„ì¥ ì§€ë„ (Map)</button>
                  <button className="w-full flex items-center px-4 py-3 rounded-xl font-bold text-sm text-slate-600 cursor-not-allowed">ğŸ–ï¸ ê·¼íƒœ ê´€ë¦¬</button>
                </div>
              </div>
            </nav>
          </aside>

          <main className="flex-1 flex flex-col h-screen overflow-hidden bg-[#F8FAFC]">
            <header className="h-14 bg-white border-b border-slate-200 flex items-center px-4 justify-between shrink-0 z-10 shadow-sm">
              <div className="flex items-center">
                <button className="p-2 text-slate-500 hover:bg-slate-100 transition rounded-lg mr-3" onClick={() => setIsSidebarOpen(!isSidebarOpen)}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <h2 className="font-black text-lg text-slate-800 tracking-tight">{activeTab === 'dash' ? 'Integrated Dashboard' : 'Field Control Map'}</h2>
              </div>
            </header>
            <div className="flex-1 overflow-hidden p-2 md:p-4">
              {activeTab === 'dash' && <DashboardView />}
              {activeTab === 'field' && <FieldView />}
            </div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
